<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12A2 TOOLS - Mã Hóa Cực Căng & Nhúng Media (Huấn HH Modal Edition)</title> <!-- Lại nâng cấp title 😎 -->
    <!-- Thư viện chuyển đổi Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Thư viện mã hóa/giải mã -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Font Icon -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* === ROOT VARIABLES === */
        :root {
            --primary: #00f7ff; --secondary: #6e00ff; --accent: #ff00aa;
            --error: #ff3d71; --success: #00ff88; --warning: #ffcc00;
            --bg-dark: #0a0a20; --bg-darker: #050510; --bg-light: rgba(20, 20, 50, 0.5);
            --bg-lighter: rgba(30, 30, 70, 0.3); --text-light: #e0e0ff;
            --text-lighter: #ffffff; --text-dim: rgba(224, 224, 255, 0.6);
            --border-radius: 12px; --box-shadow: 0 0 30px rgba(0, 247, 255, 0.2);
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --iframe-border: rgba(110, 0, 255, 0.4);
            --md-border: rgba(110, 0, 255, 0.25);
            --code-bg: rgba(0, 10, 30, 0.8);
        }
        /* === BASE STYLES === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-dark); color: var(--text-light); min-height: 100vh; overflow-x: hidden; line-height: 1.6; position: relative; }

        /* === BACKGROUND EFFECTS === */
        .particles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .particle { position: absolute; background: radial-gradient(circle, var(--primary) 0%, transparent 70%); border-radius: 50%; opacity: 0.6; animation: particle-anim linear infinite; } @keyframes particle-anim { 0%{transform:translateY(0) rotate(0deg);opacity:0;} 10%{opacity:0.6;} 100%{transform:translateY(-1500px) rotate(720deg);opacity:0;} }
        .grid-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(110, 0, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(110, 0, 255, 0.05) 1px, transparent 1px); background-size: 40px 40px; z-index: -1; pointer-events: none; }
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(0, 247, 255, 0.03), rgba(0, 247, 255, 0.03) 1px, transparent 1px, transparent 3px); z-index: -1; pointer-events: none; animation: scanline 8s linear infinite; } @keyframes scanline { 0%{background-position:0 0;} 100%{background-position:0 100%;} }
        .glow-effect { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, rgba(0, 247, 255, 0.05) 0%, transparent 70%); z-index: -1; pointer-events: none; animation: pulse 8s infinite alternate; } @keyframes pulse { 0% { opacity: 0.3; transform: scale(0.95); } 100% { opacity: 0.7; transform: scale(1.05); } }

        /* === MAIN CONTAINER (Generator) === */
        .container { max-width: 900px; margin: 2rem auto; padding: 2.5rem; background: rgba(10, 10, 32, 0.85); backdrop-filter: blur(12px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: 1px solid rgba(110, 0, 255, 0.3); position: relative; overflow: hidden; transition: var(--transition); animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .container::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at center, rgba(0, 247, 255, 0.1) 0%, transparent 60%); z-index: -1; animation: pulse 15s infinite alternate; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 2rem; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; font-size: 1.8rem; text-shadow: 0 0 15px rgba(0, 247, 255, 0.5); position: relative; padding-bottom: 1rem; } h1::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 2px; background: linear-gradient(90deg, transparent, var(--primary), transparent); } h1 > .material-icons { vertical-align: middle; font-size: 2.2rem; margin-right: 0.5rem;}

        /* === GENERATOR FORM === */
        .generator-form { display: flex; flex-direction: column; gap: 1.8rem; margin-top: 2rem; }
        .input-group { position: relative; }
        .input-group label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: var(--text-light); font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase; } .input-group .material-icons { font-size: 1.2rem; color: var(--secondary); }
        textarea#markdown-input, input[type="text"]#output-password-input, input[type="url"]#iframe-url-input, input[type="url"]#image-url-input { width: 100%; padding: 1rem 1.5rem; background: var(--bg-light); border: 1px solid rgba(110, 0, 255, 0.5); border-radius: var(--border-radius); color: var(--text-light); font-size: 1rem; transition: var(--transition); outline: none; letter-spacing: 1px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        textarea#markdown-input { min-height: 180px; font-family: 'Consolas', 'Monaco', monospace; resize: vertical; line-height: 1.5; padding: 1.5rem; border-color: rgba(110, 0, 255, 0.5) }
        textarea#markdown-input.error, input[type="text"]#output-password-input.error, input[type="url"]#iframe-url-input.error, input[type="url"]#image-url-input.error { border-color: var(--error) !important; box-shadow: 0 0 15px rgba(255, 61, 113, 0.5) !important; animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        textarea#markdown-input:focus, input[type="text"]#output-password-input:focus, input[type="url"]#iframe-url-input:focus, input[type="url"]#image-url-input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 247, 255, 0.5); transform: translateY(-2px); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .container.shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        small.input-note { color: var(--text-dim); display: block; margin-top: 0.5rem; line-height: 1.4; font-size: 0.9rem; } small.input-note .material-icons { font-size: 1rem; vertical-align: text-bottom; margin-right: 0.2rem; }

        /* === BUTTON STYLES === */
        button { background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; border: none; padding: 1rem; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; transition: var(--transition); box-shadow: 0 4px 20px rgba(110, 0, 255, 0.4); position: relative; overflow: hidden; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; } button:hover { transform: translateY(-3px); box-shadow: 0 6px 25px rgba(0, 247, 255, 0.6); } button:disabled { filter: grayscale(70%); opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none !important;} button::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to bottom right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%); transform: rotate(45deg); animation: shine 3s infinite linear; opacity: 0.5; } @keyframes shine { 0%{transform:translateX(-150%) rotate(45deg);} 100%{transform:translateX(150%) rotate(45deg);} } button > .material-icons { font-size: 1.4rem; }
        #copy-button { background: var(--bg-lighter); color: var(--text-dim); cursor: not-allowed; box-shadow: none; border: 1px solid rgba(110, 0, 255, 0.3); } #copy-button::before { display: none; } #copy-button:not(:disabled) { background: linear-gradient(135deg, #008040, var(--success)); box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4); color: white; cursor: pointer; filter: none; opacity: 1; } #copy-button:not(:disabled):hover { box-shadow: 0 6px 25px rgba(0, 255, 136, 0.6); transform: translateY(-3px); } #copy-button:not(:disabled)::before { display: block; } #copy-button.copied { background: var(--accent); box-shadow: 0 4px 20px rgba(255, 0, 170, 0.5); } #copy-button.copied > .material-icons { animation: spin 0.5s ease-in-out; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* === STATUS MESSAGE === */
        .status-message { color: var(--success); text-align: center; margin-top: 1rem; font-size: 0.95rem; min-height: 1.5rem; height: auto; transition: all 0.3s ease; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: rgba(0, 255, 136, 0.1); padding: 0.8rem 1rem; border-radius: var(--border-radius); border-left: 4px solid var(--success); opacity: 0; visibility: hidden; max-height: 0; overflow: hidden; } .status-message.show { opacity: 1; visibility: visible; max-height: 100px; } .status-message.error { color: var(--error); border-left-color: var(--error); background: rgba(255, 61, 113, 0.1); } .status-message.info { color: var(--warning); border-left-color: var(--warning); background: rgba(255, 204, 0, 0.1); } .status-message .material-icons { font-size: 1.3rem; }

        /* === ICONS === */
        .material-icons { font-family: 'Material Icons'; font-weight: normal; font-style: normal; font-size: 20px; line-height: 1; letter-spacing: normal; text-transform: none; display: inline-block; white-space: nowrap; word-wrap: normal; direction: ltr; -webkit-font-feature-settings: 'liga'; -webkit-font-smoothing: antialiased; vertical-align: middle; }

        /* === GENERIC MODAL STYLE (For Warning & Huấn Error) === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(5, 5, 16, 0.9); backdrop-filter: blur(10px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        .modal-overlay.hidden { display: none !important; }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--bg-dark); border: 1px solid var(--error); border-radius: var(--border-radius); padding: 2.5rem; max-width: 600px; width: 90%; box-shadow: 0 0 40px rgba(255, 61, 113, 0.3); position: relative; animation: scaleInModal 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(1); }
        .modal-overlay:not(.hidden).initial-state .modal-content { transform: scale(0.9); opacity: 0;}
        @keyframes scaleInModal { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { color: var(--error); text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 0.5rem; } .modal-title .material-icons { font-size: 1.8rem; }
        .modal-message { color: var(--text-light); margin-bottom: 2rem; line-height: 1.7; font-size: 1rem; }
        .modal-message p { margin-bottom: 1rem; } .modal-message strong { color: var(--warning); }
        .modal-message code { background: var(--bg-lighter); color: var(--accent); padding: 0.2em 0.5em; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85em; word-break: break-all; display: inline-block; max-width: 100%; overflow-wrap: break-word; vertical-align: middle; margin-left: 0.3rem; border: 1px solid var(--md-border); }
        .modal-message i.material-icons { font-size: 1.1rem !important; vertical-align: text-bottom; margin-right: 0.3rem;}
        .modal-button { background: linear-gradient(135deg, var(--error), #ff6b8b); color: white; border: none; padding: 1rem; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; text-align: center; box-shadow: 0 4px 15px rgba(255, 61, 113, 0.4); }
        .modal-button:hover { transform: translateY(-3px); box-shadow: 0 6px 25px rgba(255, 61, 113, 0.6); } .modal-button .material-icons { font-size: 1.4rem; }

        /* === RESPONSIVE DESIGN === */
        @media (max-width: 768px) { .container { margin: 1rem; padding: 1.5rem; animation: none; } h1 { font-size: 1.5rem; } textarea#markdown-input { min-height: 150px; padding: 1rem; } input[type="text"]#output-password-input, input[type="url"]#iframe-url-input, input[type="url"]#image-url-input { padding: 0.8rem 1rem; font-size: 0.95rem; } button { padding: 0.8rem; font-size: 0.9rem; } .modal-content { padding: 1.5rem; max-width: 95%; } .modal-title { font-size: 1.3rem; } .modal-message { font-size: 0.95rem;} }
         @media (max-width: 480px) { body { padding: 1rem 0.5rem; } .container { padding: 1.2rem; margin: 0.5rem;} h1 { font-size: 1.3rem; } .input-group label { font-size: 0.85rem; } textarea#markdown-input, input { font-size: 0.9rem;} .modal-message code { font-size: 0.8em;} small.input-note { font-size: 0.85rem; } }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="particles-container" id="particles"></div> <div class="grid-overlay"></div> <div class="scanlines"></div> <div class="glow-effect"></div>

    <!-- Generator Container -->
    <div class="container" id="generator-container">
        <h1><i class="material-icons">security</i> Mã Hóa & Nhúng Media</h1>
        <form class="generator-form" id="main-form" onsubmit="return false;">
            <div class="input-group"> <label for="markdown-input"><i class="material-icons">description</i> Nội Dung Chính (Markdown):</label> <textarea id="markdown-input" placeholder="Nhập nội dung Markdown vào đây..." required></textarea> </div>
            <div class="input-group"> <label for="output-password-input"><i class="material-icons">key</i> Đặt Mật Khẩu Bảo Mật:</label> <input type="text" id="output-password-input" placeholder="Ít nhất 8 ký tự, bảo mật mạnh!" required minlength="8"> </div>
            <div class="input-group"> <label for="image-url-input"><i class="material-icons">image</i> URL Ảnh Header (Tùy chọn):</label> <input type="url" id="image-url-input" placeholder="Dán URL ảnh..."> <small class="input-note"><i class="material-icons">info_outline</i> Ảnh hiển thị trên cùng sau giải mã.</small> </div>
            <div class="input-group"> <label for="iframe-url-input"><i class="material-icons">link</i> URL Nhúng Iframe (Tùy chọn):</label> <input type="url" id="iframe-url-input" placeholder="Dán URL nhúng..."> <small class="input-note"><i class="material-icons">info_outline</i> URL hiển thị dưới cùng trong iframe.</small> </div>
            <button type="button" id="generate-button"><i class="material-icons">enhanced_encryption</i> Tạo Mã Nguồn</button>
            <button type="button" id="copy-button" disabled><i class="material-icons">content_copy</i> Sao Chép Mã Nguồn</button>
            <div class="status-message" id="status-message"></div>
        </form>
    </div>

    <!-- Security Warning Modal Container (Generator Page) -->
    <div class="modal-overlay hidden" id="warning-modal"> <!-- Sử dụng class modal-overlay chung -->
        <!-- Nội dung được load bằng JS -->
    </div>

    <script>
        // ====== CONFIGURATION & ELEMENTS ======
        const markdownInput = document.getElementById('markdown-input');
        const outputPasswordInput = document.getElementById('output-password-input');
        const imageUrlInput = document.getElementById('image-url-input');
        const iframeUrlInput = document.getElementById('iframe-url-input');
        const generateButton = document.getElementById('generate-button');
        const copyButton = document.getElementById('copy-button');
        const statusMessage = document.getElementById('status-message');
        const warningModal = document.getElementById('warning-modal');
        const particlesContainer = document.getElementById('particles');
        let fullHtmlToCopy = '';
        let statusTimeout = null;

        // ====== UTILITY FUNCTIONS ======
        function createParticles(container) { if (!container) return; if (container.children.length > 50 && Math.random() < 0.95) return; container.innerHTML = ''; const n = window.innerWidth > 768 ? 150 : 75; for (let i = 0; i < n; i++) { const p = document.createElement('div'); p.classList.add('particle'); const s = Math.random() * 5 + 1.5; const x = Math.random() * window.innerWidth; const d = Math.random() * 10; const u = Math.random() * 15 + 10; const o = Math.random() * 0.5 + 0.1; Object.assign(p.style, { width: `${s}px`, height: `${s}px`, left: `${x}px`, bottom: `-${s}px`, animationDuration: `${u}s`, animationDelay: `${d}s`, opacity: o }); const c = ['#00f7ff', '#6e00ff', '#ff00aa', '#00ff88', '#ffffff'][Math.floor(Math.random() * 5)]; p.style.background = `radial-gradient(circle, ${c} 0%, transparent 70%)`; container.appendChild(p); } }
        function showStatus(message, type = "info", icon = "info", duration = 5000) { clearTimeout(statusTimeout); statusMessage.innerHTML = `<i class="material-icons">${icon}</i> ${message}`; statusMessage.className = 'status-message'; requestAnimationFrame(() => { statusMessage.classList.add(type); statusMessage.classList.add('show'); }); if (duration > 0) { statusTimeout = setTimeout(() => { statusMessage.classList.remove('show'); }, duration); } }
        function isValidUrl(string) { if (!string) return false; try { new URL(string); if (!string.startsWith('http:') && !string.startsWith('https:') && !string.startsWith('data:')) {} return true; } catch (_) { return false; } }

        // ====== SECURITY FUNCTIONS ======
        function multiLayerEncrypt(content, password, layers = 10) { if (typeof CryptoJS === 'undefined') throw new Error("Lỗi: CryptoJS chưa tải."); let encrypted = content; for (let i = 0; i < layers; i++) { const combined = `${encrypted}|${password}|${i}`; const layerKey = password + i; let layerEncrypted; try { layerEncrypted = CryptoJS.AES.encrypt(combined, layerKey).toString(); } catch (e) { throw new Error(`Lỗi AES lớp ${i + 1}: ${e.message || e}`); } try { encrypted = btoa(unescape(encodeURIComponent(layerEncrypted))); } catch (e) { throw new Error(`Lỗi Base64 lớp ${i + 1}: ${e.message || e}`); } } return encrypted; }

        // ====== HTML TEMPLATE GENERATION ======
        function generateTargetHtmlTemplate(markdownContentHtml, pagePassword, iframeUrl = null, imageUrl = null) {
            let encryptedMarkdownHtml;
            try { encryptedMarkdownHtml = multiLayerEncrypt(markdownContentHtml, pagePassword, 10); } catch (e) { throw new Error(`Mã hóa thất bại: ${e.message}`); }
            const escapedPassword = pagePassword.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
            const escapedIframeUrl = iframeUrl ? iframeUrl.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$') : null;
            const escapedImageUrl = imageUrl ? imageUrl.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$') : null;
            const donateMessage = `🤫 Quên mật khẩu? Đôn nết nhẹ <strong>10K</strong> vào Momo/ZaloPay <strong>0901574726</strong>, nhắn vấn đề và tớ sẽ cố gắng giúp! 😉`;
            const iframeUrlJs = escapedIframeUrl ? `\`${escapedIframeUrl}\`` : 'null';
            const imageUrlJs = escapedImageUrl ? `\`${escapedImageUrl}\`` : 'null';
            const huấnQuote = `Sau nay, chỉ có làm chịu khó cần cù thì bù siêng năng,... Cái loại xem chùa mà đòi free thì ăn cám<br><strong style="font-style:normal;font-weight:bold;font-size:1.1em;">| -_- |</strong>`; // Quote for modal

            // --- TARGET HTML TEMPLATE ---
            return `<!DOCTYPE html>
<html lang="vi">
<head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Nội Dung Bảo Mật & Media</title> <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"><\/script> <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
/* --- CSS rút gọn của Target Page --- */
:root{--primary:#00f7ff;--secondary:#6e00ff;--accent:#ff00aa;--error:#ff3d71;--success:#00ff88;--warning:#ffcc00;--bg-dark:#0a0a20;--bg-darker:#050510;--bg-light:rgba(20,20,50,.5);--bg-lighter:rgba(30,30,70,.3);--text-light:#e0e0ff;--text-lighter:#fff;--text-dim:rgba(224,224,255,.6);--border-radius:12px;--box-shadow:0 0 30px rgba(0,247,255,.2);--transition:all .4s cubic-bezier(.175,.885,.32,1.275);--iframe-border:rgba(0,247,255,.3);--iframe-bg:rgba(10,10,32,.7);--md-border:rgba(110,0,255,.25);--code-bg:rgba(0,10,30,.8)}*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:var(--bg-dark);color:var(--text-light);min-height:100vh;overflow-x:hidden;line-height:1.6;position:relative;display:flex;align-items:flex-start;justify-content:center;padding:2rem 1rem}.particles-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden}.particle{position:absolute;background:radial-gradient(circle,var(--primary) 0%,transparent 70%);border-radius:50%;opacity:.6;animation:particle-anim linear infinite}@keyframes particle-anim{0%{transform:translateY(0) rotate(0deg);opacity:0}10%{opacity:.6}100%{transform:translateY(-1500px) rotate(720deg);opacity:0}}.grid-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(rgba(110,0,255,.05) 1px,transparent 1px),linear-gradient(90deg,rgba(110,0,255,.05) 1px,transparent 1px);background-size:40px 40px;z-index:-1;pointer-events:none}.scanlines{position:fixed;top:0;left:0;width:100%;height:100%;background:repeating-linear-gradient(0deg,rgba(0,247,255,.03),rgba(0,247,255,.03) 1px,transparent 1px,transparent 3px);z-index:-1;pointer-events:none;animation:scanline 8s linear infinite}@keyframes scanline{0%{background-position:0 0}100%{background-position:0 100%}}.glow-effect{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center,rgba(0,247,255,.05) 0%,transparent 70%);z-index:-1;pointer-events:none;animation:pulse 8s infinite alternate}@keyframes pulse{0%{opacity:.3;transform:scale(.95)}100%{opacity:.7;transform:scale(1.05)}}.container{max-width:950px;width:100%;margin:2rem auto;padding:2rem 2.5rem 3rem 2.5rem;background:rgba(10,10,32,.9);backdrop-filter:blur(12px);border-radius:var(--border-radius);box-shadow:var(--box-shadow);border:1px solid rgba(110,0,255,.3);position:relative;overflow:visible;transition:var(--transition);animation:floatTarget 7s ease-in-out infinite}@keyframes floatTarget{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}.container::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at center,rgba(0,247,255,.1) 0%,transparent 60%);z-index:-1;animation:pulse 15s infinite alternate}.page-title{text-align:center;color:var(--primary);margin-bottom:2rem;font-weight:300;letter-spacing:2px;text-transform:uppercase;font-size:1.6rem;text-shadow:0 0 15px rgba(0,247,255,.5);position:relative;padding-bottom:1rem;display:flex;align-items:center;justify-content:center;gap:.7rem}.page-title .material-icons{font-size:2rem}.page-title::after{content:'';position:absolute;bottom:0;left:30%;width:40%;height:2px;background:linear-gradient(90deg,transparent,var(--primary),transparent)}.final-page-password-form{display:flex;flex-direction:column;gap:1.5rem;margin-top:2rem;max-width:400px;margin-left:auto;margin-right:auto}#final-password-section{transition:opacity .5s ease,transform .5s ease,max-height .6s ease,padding .6s ease,margin .6s ease,visibility 0s linear .6s;max-height:500px;overflow:hidden;visibility:visible;padding:1rem 0;margin-bottom:2rem}#final-password-section.hiding{opacity:0;transform:scale(.9);pointer-events:none;max-height:0;padding-top:0;padding-bottom:0;margin-bottom:0;visibility:hidden}.final-page-input-group label{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;color:var(--text-light);font-size:.9rem;letter-spacing:1px;text-transform:uppercase}.final-page-input-group label .material-icons{color:var(--secondary);font-size:1.2rem}.final-page-input-group input[type=password]{width:100%;padding:1rem 1.5rem;background:var(--bg-light);border:1px solid rgba(110,0,255,.5);border-radius:var(--border-radius);color:var(--text-light);font-size:1.1rem;transition:var(--transition);outline:none;letter-spacing:3px;font-family:'Courier New',Courier,monospace}.final-page-input-group input[type=password]:focus{border-color:var(--primary);box-shadow:0 0 15px rgba(0,247,255,.5);transform:translateY(-2px)}.final-page-button{background:linear-gradient(135deg,var(--secondary),var(--primary));color:#fff;border:none;padding:1rem;border-radius:var(--border-radius);cursor:pointer;font-size:1rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;transition:var(--transition);box-shadow:0 4px 20px rgba(110,0,255,.4);position:relative;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;gap:.5rem}.final-page-button:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 6px 25px rgba(0,247,255,.6)}.final-page-button:disabled{filter:grayscale(70%);opacity:.6;cursor:not-allowed;box-shadow:none;transform:none!important}.final-page-button::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(to bottom right,rgba(255,255,255,0) 0%,rgba(255,255,255,.1) 50%,rgba(255,255,255,0) 100%);transform:rotate(45deg);animation:shine 3s infinite linear;opacity:.5}@keyframes shine{0%{transform:translateX(-150%) rotate(45deg)}100%{transform:translateX(150%) rotate(45deg)}}.final-page-error-message{color:var(--error);text-align:center;margin-top:.5rem;margin-bottom:-.5rem;font-size:.95rem;min-height:2.5rem;font-weight:700;display:flex;align-items:center;justify-content:center;gap:.4rem;opacity:0;transition:opacity .3s ease;padding:.5rem .8rem;background:rgba(255,61,113,.1);border-left:3px solid var(--error);border-radius:4px; line-height: 1.4; display:none;} /* Hide this by default */ .final-page-error-message.show{opacity:1} .final-page-input-group input[type=password].shake{animation:shake-final .5s cubic-bezier(.36,.07,.19,.97) both;border-color:var(--error)}@keyframes shake-final{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-6px)}20%,40%,60%,80%{transform:translateX(6px)}}.final-page-donation-prompt{text-align:center;margin-top:1.5rem;padding:.8rem 1rem;background:rgba(255,204,0,.1);border-left:4px solid var(--warning);border-radius:var(--border-radius);color:var(--warning);font-size:.9rem;line-height:1.5;font-style:italic}.final-page-donation-prompt strong{font-weight:700;color:var(--text-lighter)}#final-content-section{opacity:0;visibility:hidden;max-height:0;overflow:hidden;transition:opacity .6s ease-out,max-height .8s ease-out,visibility 0s linear .8s;position:relative}#final-content-section.visible{opacity:1;visibility:visible;max-height:1000vh;transition:opacity .6s ease-out .2s,max-height .8s ease-out .2s,visibility 0s linear 0s}#final-content-section.visible>*{animation:fadeInChild .7s ease-out forwards;opacity:0}#final-content-section.visible>#embedded-image-container{animation-delay:.1s}#final-content-section.visible>#final-markdown-content{animation-delay:.3s}#final-content-section.visible>#iframe-container{animation-delay:.5s}#final-content-section.visible>.footer-note{animation-delay:.7s}@keyframes fadeInChild{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}#embedded-image-container{margin-bottom:2.5rem;border-radius:var(--border-radius);overflow:hidden;box-shadow:0 10px 30px rgba(0,247,255,.15);border:1px solid var(--iframe-border);position:relative;background-color:var(--bg-lighter)}#embedded-image-container img{display:block;width:100%;height:auto;max-height:450px;object-fit:cover;border-radius:calc(var(--border-radius) - 1px);opacity:0;transition:opacity .5s ease-in}#embedded-image-container img.loaded{opacity:1}.image-error-message{padding:1.5rem;text-align:center;color:var(--error);font-size:1rem;font-weight:700;display:flex;align-items:center;justify-content:center;gap:.5rem;min-height:100px}.image-error-message .material-icons{font-size:1.5rem}.final-template-styles{line-height:1.75;color:var(--text-light);max-width:100%;margin-bottom:3rem}.final-template-styles>:first-child{margin-top:0!important}.final-template-styles>:last-child{margin-bottom:0!important}.final-template-styles h1,.final-template-styles h2,.final-template-styles h3,.final-template-styles h4,.final-template-styles h5,.final-template-styles h6{color:var(--primary);margin-top:2rem;margin-bottom:1rem;font-weight:400;letter-spacing:1px;padding-bottom:.6rem;border-bottom:1px solid var(--md-border);position:relative;text-shadow:0 0 8px rgba(0,247,255,.2)}.final-template-styles h1::after,.final-template-styles h2::after{content:'';position:absolute;bottom:-1px;left:0;height:3px;width:80px;background:linear-gradient(90deg,var(--accent),var(--secondary));border-radius:3px;transition:width .4s ease-in-out}.final-template-styles h1:hover::after,.final-template-styles h2:hover::after{width:120px}.final-template-styles h1{font-size:2.1rem;letter-spacing:1.5px}.final-template-styles h2{font-size:1.7rem;color:var(--accent)}.final-template-styles h3{font-size:1.4rem;color:var(--success);border-bottom-style:dashed}.final-template-styles h4{font-size:1.2rem;color:var(--warning);border:none;padding-bottom:0;margin-bottom:.5rem;font-weight:500}.final-template-styles h5,.final-template-styles h6{font-size:1.1rem;color:var(--text-dim);font-weight:600;border:none;padding-bottom:0;margin-bottom:.5rem;text-transform:uppercase}.final-template-styles p{margin-bottom:1.1rem;font-size:1.05rem}.final-template-styles a{color:var(--accent);text-decoration:none;position:relative;padding-bottom:2px;transition:color .3s ease,text-shadow .3s ease;font-weight:600;overflow:hidden;display:inline-block;transform:skewX(-10deg)}.final-template-styles a::after{content:'';position:absolute;bottom:-2px;left:0;width:100%;height:2px;background:var(--primary);transform:scaleX(0);transform-origin:left;transition:transform .4s cubic-bezier(.19,1,.22,1)}.final-template-styles a:hover{color:var(--primary);text-shadow:0 0 10px var(--primary);transform:skewX(0deg)}.final-template-styles a:hover::after{transform:scaleX(1)}.final-template-styles ol,.final-template-styles ul{margin-left:1.5rem;margin-bottom:1.1rem;padding-left:1.8rem;list-style:none}.final-template-styles li{margin-bottom:.6rem;position:relative;padding-left:.5rem}.final-template-styles ul li::before{content:'✨';color:var(--primary);font-weight:400;display:inline-block;width:1em;margin-left:-1.5em;font-size:1.2em;line-height:1;position:absolute;top:.25em;left:0;text-shadow:0 0 6px var(--primary);transition:transform .3s ease}.final-template-styles ul li:hover::before{transform:rotate(90deg) scale(1.2)}.final-template-styles ol{counter-reset:list-counter}.final-template-styles ol li{counter-increment:list-counter}.final-template-styles ol li::before{content:counter(list-counter);color:var(--secondary);font-weight:700;font-size:.85em;font-family:'Georgia',serif;display:inline-flex;align-items:center;justify-content:center;width:1.8em;height:1.8em;margin-left:-1.8em;margin-right:.5em;background-color:rgba(110,0,255,.15);border-radius:50%;border:1px solid var(--secondary);position:absolute;top:.15em;left:0;line-height:1.8em;box-shadow:0 0 5px rgba(110,0,255,.3);transition:background-color .3s ease,transform .3s ease}.final-template-styles ol li:hover::before{background-color:rgba(110,0,255,.4);transform:scale(1.1)}.final-template-styles li p{margin-bottom:.3rem}.final-template-styles blockquote{position:relative;border:none;border-left:6px solid;border-image:linear-gradient(to bottom,var(--secondary),var(--primary)) 1;padding:1.5rem 2rem 1.5rem 3.5rem;margin:2rem 0;background:linear-gradient(135deg,rgba(110,0,255,.08),rgba(110,0,255,.2));border-radius:0 var(--border-radius) var(--border-radius) 0;font-style:italic;font-size:1.1em;color:var(--text-lighter);box-shadow:inset 5px 0 15px -5px rgba(110,0,255,.4);backdrop-filter:blur(2px)}.final-template-styles blockquote::before{content:'format_quote';font-family:'Material Icons';font-size:3rem;color:var(--secondary);opacity:.5;position:absolute;left:.8rem;top:.5rem;transform:translateY(-10%)}.final-template-styles blockquote p{margin-bottom:.6rem;font-size:1em}.final-template-styles blockquote p:last-child{margin-bottom:0}.final-template-styles code:not(pre code){background:rgba(0,247,255,.1);color:var(--primary);padding:.3em .6em;border-radius:5px;font-family:'Fira Code','Consolas',monospace;font-size:.9em;border:1px solid rgba(0,247,255,.3);word-break:break-word;text-shadow:0 0 3px rgba(0,247,255,.5)}.final-template-styles pre{background:var(--code-bg);padding:1.5rem 1.8rem;border-radius:var(--border-radius);overflow-x:auto;margin:2rem 0;border:1px solid var(--secondary);box-shadow:0 0 25px rgba(110,0,255,.25),inset 0 0 15px rgba(0,0,0,.6);position:relative}.final-template-styles pre code{background:0 0;padding:0;font-size:.95em;line-height:1.65;color:var(--text-light);font-family:'Fira Code','Consolas','Monaco',monospace}.final-template-styles pre::-webkit-scrollbar{height:8px;background-color:rgba(0,0,0,.2)}.final-template-styles pre::-webkit-scrollbar-thumb{background:linear-gradient(90deg,var(--secondary),var(--primary));border-radius:4px}.final-template-styles hr{border:0;height:2px;margin:3rem auto;width:70%;background:linear-gradient(90deg,transparent,var(--secondary) 20%,var(--primary) 80%,transparent);opacity:.6}.final-template-styles table{width:100%;border-collapse:separate;border-spacing:0;margin:2rem 0;background:0 0;border:1px solid var(--md-border);border-radius:var(--border-radius);box-shadow:0 8px 25px rgba(0,0,0,.4);overflow:hidden}.final-template-styles td,.final-template-styles th{border-bottom:1px solid var(--md-border);padding:1rem 1.2rem;text-align:left;transition:background-color .3s ease}.final-template-styles td{background-color:rgba(10,10,32,.5)}.final-template-styles tr:last-child td{border-bottom:none}.final-template-styles th{background:linear-gradient(135deg,rgba(110,0,255,.3),rgba(0,247,255,.3));color:var(--text-lighter);font-weight:700;text-transform:uppercase;font-size:.9em;letter-spacing:1px;border-bottom:2px solid var(--primary)}.final-template-styles td:first-child,.final-template-styles th:first-child{border-left:1px solid var(--md-border);padding-left:1.5rem}.final-template-styles td:last-child,.final-template-styles th:last-child{border-right:1px solid var(--md-border);padding-right:1.5rem}.final-template-styles tr:hover td{background-color:var(--bg-lighter);color:var(--text-lighter)}.final-template-styles img{max-width:100%;height:auto;border-radius:8px;margin:1.5rem 0;box-shadow:0 8px 25px rgba(0,0,0,.4);border:1px solid var(--iframe-border);display:block;background:var(--bg-lighter);transition:transform .3s ease,box-shadow .3s ease,filter .3s ease}.final-template-styles img:hover{transform:scale(1.03);box-shadow:0 12px 40px rgba(0,247,255,.25);filter:brightness(1.1)}#iframe-container{margin-top:3rem;border:1px solid var(--iframe-border);border-radius:var(--border-radius);overflow:hidden;background-color:var(--iframe-bg);box-shadow:0 10px 30px rgba(0,247,255,.2);position:relative;width:100%;padding-top:56.25%}#embedded-iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none;border-radius:calc(var(--border-radius) - 1px)}
/* === MODAL STYLE === */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(5, 5, 16, 0.9); backdrop-filter: blur(10px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; } .modal-overlay.hidden { display: none !important; } .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; } .modal-content { background: var(--bg-dark); border: 1px solid var(--error); border-radius: var(--border-radius); padding: 2.5rem; max-width: 600px; width: 90%; box-shadow: 0 0 40px rgba(255, 61, 113, 0.3); position: relative; animation: scaleInModal 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(1); } .modal-overlay:not(.hidden).initial-state .modal-content { transform: scale(0.9); opacity: 0;} @keyframes scaleInModal { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } } .modal-title { color: var(--error); text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 0.5rem; } .modal-title .material-icons { font-size: 1.8rem; } .modal-message { color: var(--text-light); margin-bottom: 2rem; line-height: 1.7; font-size: 1.1rem; text-align: center;} /* Center quote */ .modal-message p { margin-bottom: 1rem; } .modal-message strong { color: var(--warning); } .modal-button { background: linear-gradient(135deg, var(--error), #ff6b8b); color: white; border: none; padding: 1rem; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: bold; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 15px rgba(255, 61, 113, 0.4); transition: var(--transition); } .modal-button:hover { transform: translateY(-3px); box-shadow: 0 6px 25px rgba(255, 61, 113, 0.6); } .hidden{display:none!important;visibility:hidden}.text-center{text-align:center}.footer-note{text-align:center;margin-top:3rem;font-size:.9rem;color:var(--text-dim);opacity:.8;letter-spacing:.5px}.footer-note .material-icons{font-size:1rem;vertical-align:middle;margin-right:.2rem}.spin{animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}
@media (max-width:768px){body{padding:1rem}.container{padding:1.5rem;margin:1rem auto}.final-page-password-form{max-width:100%}.page-title{font-size:1.4rem}#iframe-container{padding-top:75%}.final-template-styles h1{font-size:1.8rem}.final-template-styles h2{font-size:1.5rem}.final-template-styles blockquote{padding:1rem 1.5rem 1rem 2.5rem}.final-template-styles blockquote::before{left:.5rem;font-size:2.5rem}.final-template-styles pre{padding:1.2rem}.final-template-styles td,.final-template-styles th{padding:.8rem 1rem}.modal-content{padding:1.5rem;max-width:95%}.modal-title{font-size:1.3rem}.modal-message{font-size:1rem}}@media (max-width:480px){.final-page-password-form{gap:1.2rem}.final-page-input-group input[type=password]{padding:.8rem 1rem;font-size:1rem}.page-title{font-size:1.3rem}.modal-title{font-size:1.2rem}.modal-message{font-size:0.95rem; line-height: 1.6;} .final-template-styles h1{font-size:1.6rem}.final-template-styles h2{font-size:1.3rem}.final-template-styles h3{font-size:1.2rem}.final-template-styles code:not(pre code){font-size:.85em}.final-template-styles pre code{font-size:.9em}.final-template-styles table{font-size:.9rem}.final-template-styles td,.final-template-styles th{padding:.6rem .8rem}}
</style>
</head>
<body>
    <div class="particles-container" id="final-particles"></div> <div class="grid-overlay"></div> <div class="scanlines"></div> <div class="glow-effect"></div>
    <div class="container">
        <div id="final-password-section">
            <h1 class="page-title"><i class="material-icons">lock_person</i> Truy Cập Nội Dung</h1>
            <form class="final-page-password-form" id="password-form" onsubmit="checkFinalPagePassword(event)">
                <div class="final-page-input-group"> <label for="final-password-input"><i class="material-icons">password</i> Mã Truy Cập:</label> <input type="password" id="final-password-input" placeholder="••••••••••••" autocomplete="current-password" required> </div>
                <div class="final-page-donation-prompt">${donateMessage}</div>
                <button type="submit" class="final-page-button" id="final-submit-btn"> <i class="material-icons">sensors</i> Giải Mã & Hiển Thị </button>
                <div class="final-page-error-message" id="final-error-message"></div> <!-- Vẫn giữ để báo lỗi nhập trống -->
            </form>
        </div>
        <div id="final-content-section">
            <div id="embedded-image-container" style="display: none;"></div>
            <div class="final-template-styles" id="final-markdown-content"></div>
            <div id="iframe-container" style="display: none;"> <iframe id="embedded-iframe" title="Embedded Content" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe> </div>
            <div class="footer-note"><i class="material-icons">verified_user</i> An toàn với 10 lớp mã hóa AES.</div>
        </div>
    </div>
    <!-- Initial Warning Modal -->
    <div class="modal-overlay hidden initial-state" id="final-warning-modal">
         <div class="modal-content"> <h2 class="modal-title"><i class="material-icons">gpp_bad</i> CẢNH BÁO</h2> <div class="modal-message"> <p>Truy cập vào vùng dữ liệu mã hóa cao.</p> <p>Mọi hành vi trái phép đều có thể bị ghi nhận.</p> <p><strong>Luôn bảo mật thông tin!</strong></p> </div> <button class="modal-button" id="final-warning-confirm"> <i class="material-icons">check_circle_outline</i> TÔI ĐÃ HIỂU </button> </div>
    </div>
    <!-- ✨✨✨ Huấn Error Modal ✨✨✨ -->
    <div class="modal-overlay hidden initial-state" id="huan-error-modal">
         <div class="modal-content"> <h2 class="modal-title" style="color: var(--warning);"><i class="material-icons">sentiment_very_dissatisfied</i> Sai Rồi Fen!</h2> <div class="modal-message" style="font-style: italic;"> <p>\`${huấnQuote}\`</p> </div> <button class="modal-button" id="huan-error-confirm" style="background: linear-gradient(135deg, var(--warning), #ffd54f); color: var(--bg-darker);"> <i class="material-icons">refresh</i> THỬ LẠI ĐI </button> </div>
    </div>

    <script>
        const encryptedMarkdownContent=\`${encryptedMarkdownHtml}\`; const embeddedImageUrl=${imageUrlJs}; const embeddedIframeUrl=${iframeUrlJs}; const finalPasswordSection=document.getElementById('final-password-section'); const finalContentSection=document.getElementById('final-content-section'); const finalPasswordInput=document.getElementById('final-password-input'); const finalErrorMessage=document.getElementById('final-error-message'); const finalImageContainer=document.getElementById('embedded-image-container'); const finalMarkdownContentDiv=document.getElementById('final-markdown-content'); const finalIframeContainer=document.getElementById('iframe-container'); const finalIframePlayer=document.getElementById('embedded-iframe'); const finalWarningModal=document.getElementById('final-warning-modal'); const finalWarningConfirmBtn=document.getElementById('final-warning-confirm'); const huanErrorModal=document.getElementById('huan-error-modal'); /* <<< Get Huấn modal */ const huanErrorConfirmBtn=document.getElementById('huan-error-confirm'); /* <<< Get Huấn confirm btn */ const finalParticlesContainer=document.getElementById('final-particles'); const submitButton=document.getElementById('final-submit-btn');
        function createFinalParticles(){if(!finalParticlesContainer||finalParticlesContainer.children.length>40)return;finalParticlesContainer.innerHTML='';const n=window.innerWidth>768?120:60;for(let i=0;i<n;i++){const p=document.createElement('div');p.classList.add('particle');const s=Math.random()*4+1;const x=Math.random()*window.innerWidth;const d=Math.random()*12;const u=Math.random()*18+12;const o=Math.random()*.4+.1;Object.assign(p.style,{width:\`\${s}px\`,height:\`\${s}px\`,left:\`\${x}px\`,bottom:\`-\${s}px\`,animationDuration:\`\${u}s\`,animationDelay:\`\${d}s\`,opacity:o});const c=['#00f7ff','#6e00ff','#ff00aa'][Math.floor(Math.random()*3)];p.style.background=\`radial-gradient(circle, \${c} 0%, transparent 70%)\`;finalParticlesContainer.appendChild(p)}}
        function multiLayerDecrypt(encryptedData,password,layers=10){if(typeof CryptoJS==='undefined')throw new Error("Lỗi: Không tìm thấy CryptoJS.");let d=encryptedData;try{for(let i=layers-1;i>=0;i--){let b=decodeURIComponent(escape(atob(d)));let k=password+i;let y=CryptoJS.AES.decrypt(b,k);let u=y.toString(CryptoJS.enc.Utf8);if(!u)throw new Error(\`Giải mã lớp \${i+1} thất bại - Sai MK?\`);const p=u.split("|");if(p.length<3||p[1]!==password)throw new Error(\`Xác thực lớp \${i+1} thất bại - Sai MK?\`);d=p[0]}return d}catch(e){throw new Error('decrypt-fail')}} /* Thay đổi error để dễ bắt trong catch */
        function showInlineError(message){ /* Function for non-modal errors */ finalErrorMessage.style.display = 'flex'; /* Make inline error visible */ finalErrorMessage.innerHTML=\`<i class="material-icons">error</i> \${message||'Lỗi không xác định'}\`; finalErrorMessage.classList.add('show');finalPasswordInput.classList.add('shake');setTimeout(()=>finalPasswordInput.classList.remove('shake'),500) }
        function showHuanModal() { /* Function to show Huấn modal */ if(!huanErrorModal) return; huanErrorModal.classList.add('initial-state'); huanErrorModal.classList.remove('hidden'); requestAnimationFrame(()=>{huanErrorModal.classList.remove('initial-state')}); }

        function checkFinalPagePassword(event){
            if(event)event.preventDefault();const enteredPassword=finalPasswordInput.value; finalErrorMessage.style.display = 'none'; /* Hide inline error initially */ finalPasswordInput.classList.remove('shake');
            if(!enteredPassword){showInlineError('Chưa nhập mã mà fen!');finalPasswordInput.focus();return} submitButton.disabled=true;submitButton.innerHTML='<i class="material-icons spin">hourglass_top</i> Check pass...';
            setTimeout(()=>{
                try{ const decryptedHtml=multiLayerDecrypt(encryptedMarkdownContent,enteredPassword,10); /* Populate content (code rút gọn) */ finalImageContainer.innerHTML='';finalImageContainer.style.display='none';if(embeddedImageUrl){finalImageContainer.style.display='block';const img=document.createElement('img');img.alt="Header";img.onerror=()=>{finalImageContainer.innerHTML='<div class="image-error-message">Ảnh lỗi</div>';img.classList.add('loaded')};img.onload=()=>{img.classList.add('loaded')};img.src=embeddedImageUrl;finalImageContainer.appendChild(img)} finalMarkdownContentDiv.innerHTML=decryptedHtml; finalIframeContainer.style.display='none';if(embeddedIframeUrl){finalIframeContainer.style.display='block';finalIframePlayer.src='about:blank';setTimeout(()=>{finalIframePlayer.src=embeddedIframeUrl},50);finalIframePlayer.onerror=()=>{finalIframeContainer.innerHTML='<div class="image-error-message">Lỗi iframe</div>'}}else{finalMarkdownContentDiv.style.marginBottom='0'} finalPasswordSection.classList.add('hiding');finalContentSection.classList.add('visible'); setTimeout(()=>{const focusTarget=finalContentSection.querySelector('h1')||finalContentSection;if(focusTarget)focusTarget.focus({preventScroll:false})},600)
                }catch(e){
                    if(e.message === 'decrypt-fail') { /* Chỉ hiện modal Huấn khi lỗi giải mã */
                         showHuanModal();
                    } else { /* Các lỗi khác (hiếm) vẫn dùng inline error */
                        showInlineError(e.message || "Lỗi không xác định.");
                    }
                    finalPasswordInput.value=''; /* Xóa pass sai */
                    /* Focus sẽ đặt sau khi modal Huấn đóng */
                    finalContentSection.classList.remove('visible')
                }finally{submitButton.disabled=false;submitButton.innerHTML='<i class="material-icons">sensors</i> Giải Mã & Hiển Thị'}
            },100)
        }

        document.addEventListener('DOMContentLoaded',()=>{createFinalParticles();if(finalWarningModal&&finalWarningConfirmBtn){finalWarningModal.classList.remove('hidden','initial-state');finalWarningConfirmBtn.onclick=()=>{finalWarningModal.classList.add('hidden');setTimeout(()=>finalPasswordInput.focus(),100)};finalWarningModal.onclick=(e)=>{if(e.target===finalWarningModal)finalWarningConfirmBtn.click()}}else{finalPasswordInput.focus()}
        if(huanErrorModal && huanErrorConfirmBtn) { /* Setup Huấn modal close */ huanErrorConfirmBtn.onclick=()=>{huanErrorModal.classList.add('hidden');finalPasswordInput.focus()}; huanErrorModal.onclick=(e)=>{if(e.target===huanErrorModal)huanErrorConfirmBtn.click()} }
        finalPasswordInput.addEventListener('keydown',(e)=>{if(e.key==='Enter')checkFinalPagePassword(e)});finalContentSection.setAttribute('tabindex','-1');}); let finalResizeTimeout;window.addEventListener('resize',()=>{clearTimeout(finalResizeTimeout);finalResizeTimeout=setTimeout(createFinalParticles,300)});
    <\/script>
</body>
</html>`;
        }

        // ====== GENERATOR PAGE FUNCTIONS ======
        function handleGenerate() { const markdownText = markdownInput.value.trim(); const outputPassword = outputPasswordInput.value; const imageUrl = imageUrlInput.value.trim(); const iframeUrl = iframeUrlInput.value.trim(); markdownInput.classList.remove('error'); outputPasswordInput.classList.remove('error'); imageUrlInput.classList.remove('error'); iframeUrlInput.classList.remove('error'); statusMessage.classList.remove('show'); let isValid = true; let firstErrorField = null; if (!markdownText) { showStatus("Chưa nhập nội dung kìa.", "error", "edit_note", 6000); markdownInput.classList.add('error'); if (!firstErrorField) firstErrorField = markdownInput; isValid = false; } if (!outputPassword || outputPassword.length < 8) { showStatus("Mật khẩu ngắn quá (ít nhất 8 ký tự).", "error", "password", 6000); outputPasswordInput.classList.add('error'); if (!firstErrorField) firstErrorField = outputPasswordInput; isValid = false; } if (imageUrl && !isValidUrl(imageUrl)) { showStatus("Link ảnh không đúng.", "error", "broken_image", 7000); imageUrlInput.classList.add('error'); if (!firstErrorField) firstErrorField = imageUrlInput; isValid = false; } if (iframeUrl && !isValidUrl(iframeUrl)) { showStatus("Link iframe không đúng.", "error", "link_off", 7000); iframeUrlInput.classList.add('error'); if (!firstErrorField) firstErrorField = iframeUrlInput; isValid = false; } if (!isValid) { if (firstErrorField) firstErrorField.focus(); document.getElementById('generator-container').classList.add('shake'); return; } try { if (typeof marked === 'undefined' || typeof CryptoJS === 'undefined') throw new Error("Thư viện chưa tải xong, F5 lại?"); marked.setOptions({ gfm: true, breaks: true, mangle: false, headerIds: false }); const convertedHtml = marked.parse(markdownText); loadAndShowWarningModal(() => { showStatus("Đang xử lý...", "info", "hourglass_empty", 0); generateButton.disabled = true; copyButton.disabled = true; copyButton.classList.remove('copied'); copyButton.innerHTML = '<i class="material-icons">content_copy</i> Sao Chép'; setTimeout(() => { try { fullHtmlToCopy = generateTargetHtmlTemplate(convertedHtml, outputPassword, iframeUrl || null, imageUrl || null); if (!fullHtmlToCopy || typeof fullHtmlToCopy !== 'string' || fullHtmlToCopy.length < 500) throw new Error("Kết quả tạo HTML lỗi."); showStatus("Xong! Sẵn sàng copy.", "success", "done_all", 5000); copyButton.disabled = false; copyButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch (genError) { console.error("HTML generation error:", genError); showStatus(`Lỗi tạo HTML: ${genError.message}`, "error", "error_outline", 10000); fullHtmlToCopy = ''; copyButton.disabled = true; } finally { generateButton.disabled = false; } }, 50); }); } catch (processingError) { console.error("Processing Error:", processingError); showStatus(`Lỗi xử lý: ${processingError.message}`, "error", "error", 8000); fullHtmlToCopy = ''; copyButton.disabled = true; generateButton.disabled = false; } }
        function handleCopy() { if (!fullHtmlToCopy) { showStatus("Chưa có gì để copy.", "info", "info"); return; } if (!navigator.clipboard) { showStatus("Trình duyệt không hỗ trợ copy tự động.", "error", "report_problem", 7000); alert("Lỗi copy. Mã đã in ra Console (F12)."); console.log(fullHtmlToCopy); return; } navigator.clipboard.writeText(fullHtmlToCopy).then(() => { showStatus("Đã copy! ✨", "success", "done_all", 3000); copyButton.classList.add('copied'); copyButton.innerHTML = '<i class="material-icons">check_circle</i> Đã Copy!'; setTimeout(() => { if (copyButton.classList.contains('copied')) { copyButton.classList.remove('copied'); copyButton.innerHTML = '<i class="material-icons">content_copy</i> Sao Chép'; } }, 3000); }).catch(err => { console.error('Copy error: ', err); showStatus("Lỗi copy!", "error", "report_problem"); }); }
        function loadAndShowWarningModal(onConfirmCallback) { const currentImageUrl = imageUrlInput.value.trim(); const currentIframeUrl = iframeUrlInput.value.trim(); const hasImage = !!currentImageUrl; const hasIframe = !!currentIframeUrl; const truncateUrl = (url, len = 80) => url && url.length > len ? url.substring(0, len - 3) + '...' : url; let mediaInfo = ''; if (hasImage && hasIframe) mediaInfo = `<p style="color:var(--primary);"><i class="material-icons">perm_media</i><strong>Nhúng:</strong></p><p><i class="material-icons">image</i>Ảnh: <code title="${currentImageUrl}">${truncateUrl(currentImageUrl)}</code></p><p><i class="material-icons">integration_instructions</i>Iframe: <code title="${currentIframeUrl}">${truncateUrl(currentIframeUrl)}</code></p>`; else if (hasImage) mediaInfo = `<p><i class="material-icons">image</i><strong>Ảnh Header:</strong> <code title="${currentImageUrl}">${truncateUrl(currentImageUrl, 100)}</code></p>`; else if (hasIframe) mediaInfo = `<p><i class="material-icons">integration_instructions</i><strong>Iframe URL:</strong> <code title="${currentIframeUrl}">${truncateUrl(currentIframeUrl, 100)}</code></p>`; else mediaInfo = '<p style="color:var(--text-dim);"><i class="material-icons">web_asset_off</i><em>(Không nhúng gì thêm)</em></p>'; const modalHtml = ` <div class="modal-content"> <h2 class="modal-title"><i class="material-icons">security</i> Xác nhận tạo mã</h2> <div class="modal-message"> <p>Nội dung sẽ được mã hóa <strong>10 lớp AES</strong>. Mật khẩu mất là mất luôn đó nha!</p> <hr style="border:0;height:1px;background:var(--md-border);margin:1rem 0;"> ${mediaInfo} <hr style="border:0;height:1px;background:var(--md-border);margin:1rem 0;"> <p style="color:var(--warning);font-weight:bold;"><i class="material-icons">warning_amber</i> Nhấn OK để xác nhận.</p> </div> <button class="modal-button" id="gen-warning-confirm"> <i class="material-icons">check_circle</i> OK, Tạo Ngay! </button> </div>`; warningModal.innerHTML = modalHtml; const confirmBtn = warningModal.querySelector('#gen-warning-confirm'); const warningContent = warningModal.querySelector('.modal-content'); const newConfirmBtn = confirmBtn.cloneNode(true); warningContent.replaceChild(newConfirmBtn, confirmBtn); newConfirmBtn.onclick = () => { warningModal.classList.add('hidden'); if (typeof onConfirmCallback === 'function') setTimeout(onConfirmCallback, 50); }; const modalClickHandler = (event) => { if (event.target === warningModal) { warningModal.classList.add('hidden'); }}; warningModal.removeEventListener('click', modalClickHandler); warningModal.addEventListener('click', modalClickHandler); warningModal.classList.add('initial-state'); warningModal.classList.remove('hidden'); requestAnimationFrame(() => { warningModal.classList.remove('initial-state'); }); }

        // ====== INITIALIZATION ======
        document.addEventListener('DOMContentLoaded', function() { try { createParticles(particlesContainer); generateButton.addEventListener('click', handleGenerate); copyButton.addEventListener('click', handleCopy); [markdownInput, outputPasswordInput, imageUrlInput, iframeUrlInput].forEach(input => { if(input) { input.addEventListener('input', () => input.classList.remove('error')); }}); showStatus("✨ Nhập liệu để mã hóa nào! ✨", "info", "auto_awesome", 7000); let resizeTimeout; window.addEventListener('resize', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(() => createParticles(particlesContainer), 300); }); } catch (e) { console.error("Init Error:", e); alert("Lỗi khởi tạo. Kiểm tra Console (F12)."); } });
    </script>
</body>
</html>
