<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12A2 TOOLS - M√£ H√≥a Si√™u C·∫•p & Nh√∫ng ƒêa Ph∆∞∆°ng Ti·ªán v2.2 ‚ú®</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* === ROOT VARIABLES === */
        :root {
            --primary: #00f7ff; --secondary: #6e00ff; --accent: #ff00aa;
            --error: #ff3d71; --success: #00ff88; --warning: #ffcc00;
            --bg-dark: #0a0a20; --bg-darker: #050510; --bg-light: rgba(20, 20, 50, 0.5);
            --bg-lighter: rgba(30, 30, 70, 0.3); --text-light: #e0e0ff;
            --text-lighter: #ffffff; --text-dim: rgba(224, 224, 255, 0.6);
            --border-radius: 12px; --box-shadow: 0 0 30px rgba(0, 247, 255, 0.2);
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --iframe-border: rgba(110, 0, 255, 0.4);
            --md-border: rgba(110, 0, 255, 0.25);
            --code-bg: rgba(0, 10, 30, 0.8);
            --expired-color: var(--error);
            --expired-bg: rgba(255, 61, 113, 0.1);
            /* Study Mode Colors */
            --study-question-border: rgba(0, 247, 255, 0.5);
            --study-question-bg: rgba(0, 100, 120, 0.1);
            --study-answer-color: var(--success);
            --study-explanation-bg: rgba(110, 0, 255, 0.1);
            --study-explanation-border: var(--secondary);
        }
        /* === BASE STYLES === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-dark); color: var(--text-light); min-height: 100vh; overflow-x: hidden; line-height: 1.6; position: relative; display: flex; align-items: center; /* Center vertically */ justify-content: center; padding: 2rem 1rem; }

        /* === BACKGROUND EFFECTS === */
        .particles-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .particle { position: absolute; background: radial-gradient(circle, var(--primary) 0%, transparent 70%); border-radius: 50%; opacity: 0.6; animation: particle-anim linear infinite; } @keyframes particle-anim { 0%{transform:translateY(0) rotate(0deg);opacity:0;} 10%{opacity:0.6;} 100%{transform:translateY(-1500px) rotate(720deg);opacity:0;} }
        .grid-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(110, 0, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(110, 0, 255, 0.05) 1px, transparent 1px); background-size: 40px 40px; z-index: -1; pointer-events: none; }
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(0, 247, 255, 0.03), rgba(0, 247, 255, 0.03) 1px, transparent 1px, transparent 3px); z-index: -1; pointer-events: none; animation: scanline 8s linear infinite; } @keyframes scanline { 0%{background-position:0 0;} 100%{background-position:0 100%;} }
        .glow-effect { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, rgba(0, 247, 255, 0.05) 0%, transparent 70%); z-index: -1; pointer-events: none; animation: pulse 8s infinite alternate; } @keyframes pulse { 0% { opacity: 0.3; transform: scale(0.95); } 100% { opacity: 0.7; transform: scale(1.05); } }

        /* === MAIN CONTAINER (Generator) === */
        .container { max-width: 950px; margin: 2rem auto; padding: 2.5rem; background: rgba(10, 10, 32, 0.85); backdrop-filter: blur(12px); border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: 1px solid rgba(110, 0, 255, 0.3); position: relative; overflow: hidden; transition: var(--transition); animation: float 6s ease-in-out infinite; width: 100%; /* Ensure it takes width */ }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .container::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at center, rgba(0, 247, 255, 0.1) 0%, transparent 60%); z-index: -1; animation: pulse 15s infinite alternate; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 2rem; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; font-size: 1.8rem; text-shadow: 0 0 15px rgba(0, 247, 255, 0.5); position: relative; padding-bottom: 1rem; } h1::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 2px; background: linear-gradient(90deg, transparent, var(--primary), transparent); } h1 > .material-icons { vertical-align: middle; font-size: 2.2rem; margin-right: 0.5rem;}

        /* === GENERATOR FORM === */
        .generator-form { display: flex; flex-direction: column; gap: 1.8rem; margin-top: 2rem; }
        .input-group { position: relative; }
        .input-group label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: var(--text-light); font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase; } .input-group .material-icons { font-size: 1.2rem; color: var(--secondary); }
        textarea#markdown-input, input[type="text"]#output-password-input, input[type="url"], select#image-layout-select, input[type="number"] {
            width: 100%; padding: 1rem 1.5rem; background: var(--bg-light); border: 1px solid rgba(110, 0, 255, 0.5); border-radius: var(--border-radius); color: var(--text-light); font-size: 1rem; transition: var(--transition); outline: none; letter-spacing: 1px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        textarea#markdown-input { min-height: 180px; font-family: 'Consolas', 'Monaco', monospace; resize: vertical; line-height: 1.5; padding: 1.5rem; border-color: rgba(110, 0, 255, 0.5) }
        select#image-layout-select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2300f7ff' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; padding-right: 3rem; cursor: pointer; }
        select#image-layout-select option { background-color: var(--bg-darker); color: var(--text-light); padding: 0.5rem 1rem; }
        input[type="number"] { letter-spacing: 2px; text-align: center; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        textarea#markdown-input.error, input[type="text"]#output-password-input.error, input[type="url"].error, select#image-layout-select.error, input[type="number"].error { border-color: var(--error) !important; box-shadow: 0 0 15px rgba(255, 61, 113, 0.5) !important; }
        textarea#markdown-input:focus, input[type="text"]#output-password-input:focus, input[type="url"]:focus, select#image-layout-select:focus, input[type="number"]:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 247, 255, 0.5); transform: translateY(-2px); }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .container.shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        small.input-note { color: var(--text-dim); display: block; margin-top: 0.5rem; line-height: 1.4; font-size: 0.9rem; } small.input-note .material-icons { font-size: 1rem; vertical-align: text-bottom; margin-right: 0.2rem; }

        /* === Layout Mode Selection (Generator) === */
        .layout-mode-selector { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; background: var(--bg-light); padding: 0.8rem 1.2rem; border-radius: var(--border-radius); border: 1px solid rgba(110, 0, 255, 0.3); }
        .layout-mode-selector label { margin-bottom: 0; text-transform: none; font-size: 0.95rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem; transition: color 0.3s ease;}
        .layout-mode-selector input[type="radio"] { appearance: none; width: 1.2em; height: 1.2em; border: 2px solid var(--primary); border-radius: 50%; margin-right: 0.2em; cursor: pointer; transition: all 0.3s ease; position: relative; outline: none; display: grid; place-content: center;}
        .layout-mode-selector input[type="radio"]::before { content: ''; width: 0.6em; height: 0.6em; border-radius: 50%; background-color: var(--accent); transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: 0 0 10px var(--accent); }
        .layout-mode-selector input[type="radio"]:checked::before { transform: scale(1); }
        .layout-mode-selector input[type="radio"]:checked { border-color: var(--accent); box-shadow: 0 0 10px rgba(255, 0, 170, 0.5); }
        .layout-mode-selector label:has(input:checked) { color: var(--accent); font-weight: bold;}
        .layout-mode-selector label:hover { color: var(--primary); }

        /* === Dynamic Input List Styles === */
        .input-list { display: flex; flex-direction: column; gap: 0.8rem; max-height: 250px; overflow-y: auto; padding-right: 10px; margin-bottom: 1rem; border: 1px dashed var(--md-border); padding: 1rem; border-radius: var(--border-radius); background: rgba(0,0,0,0.1); }
        .input-list-item { display: flex; align-items: center; gap: 0.8rem; transition: var(--transition); animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }
        .input-list-item input[type="url"] { flex-grow: 1; margin: 0; }
        .input-list-item button { padding: 0.6rem; font-size: 0.8rem; line-height: 1; min-width: 40px; background: linear-gradient(135deg, var(--error), #ff6b8b); box-shadow: 0 2px 10px rgba(255, 61, 113, 0.3); color: white; border-radius: 8px; border: none; cursor: pointer; transition: var(--transition); }
        .input-list-item button:hover { background: linear-gradient(135deg, #ff6b8b, var(--error)); transform: translateY(-1px) scale(1.05); box-shadow: 0 4px 15px rgba(255, 61, 113, 0.5);}
        .add-button { background: linear-gradient(135deg, var(--success), #45eda0); color: var(--bg-darker); padding: 0.7rem 1rem; font-size: 0.9rem; font-weight: 600; box-shadow: 0 3px 15px rgba(0, 255, 136, 0.3); display: inline-flex; align-items: center; gap: 0.4rem; border: none; cursor: pointer; border-radius: var(--border-radius); transition: var(--transition); margin-top: 0.5rem; }
        .add-button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 255, 136, 0.5);}
        .input-list::-webkit-scrollbar { width: 6px; }
        .input-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 3px; }
        .input-list::-webkit-scrollbar-thumb { background: linear-gradient(var(--secondary), var(--primary)); border-radius: 3px; }
        .input-list:empty::after { content: 'Ch∆∞a c√≥ link n√†o ƒë∆∞·ª£c th√™m...'; display: block; text-align: center; color: var(--text-dim); font-style: italic; padding: 1rem 0; }

        /* Styles for Expiry Date Inputs */
        .expiry-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 0.8rem; align-items: end; }
        .expiry-inputs .input-group { margin-bottom: 0; }
        .expiry-inputs label { font-size: 0.8rem; margin-bottom: 0.3rem; gap: 0.3rem; }
        .expiry-inputs label .material-icons { font-size: 1rem; }
        .expiry-inputs input[type="number"] { padding: 0.7rem 0.5rem; font-size: 0.95rem; }

        /* === BUTTON STYLES === */
        button { background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; border: none; padding: 1rem; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; transition: var(--transition); box-shadow: 0 4px 20px rgba(110, 0, 255, 0.4); position: relative; overflow: hidden; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        button:hover:not(:disabled) { transform: translateY(-3px) scale(1.03); box-shadow: 0 6px 25px rgba(0, 247, 255, 0.6); }
        button:disabled { filter: grayscale(70%); opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none !important;}
        button::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to bottom right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%); transform: rotate(45deg); animation: shine 3s infinite linear; opacity: 0.5; pointer-events: none; }
        @keyframes shine { 0%{transform:translateX(-150%) rotate(45deg);} 100%{transform:translateX(150%) rotate(45deg);} }
        button > .material-icons { font-size: 1.4rem; }
        #copy-button { background: var(--bg-lighter); color: var(--text-dim); cursor: not-allowed; box-shadow: none; border: 1px solid rgba(110, 0, 255, 0.3); }
        #copy-button::before { display: none; }
        #copy-button:not(:disabled) { background: linear-gradient(135deg, #008040, var(--success)); box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4); color: white; cursor: pointer; filter: none; opacity: 1; }
        #copy-button:not(:disabled):hover { box-shadow: 0 6px 25px rgba(0, 255, 136, 0.6); transform: translateY(-3px) scale(1.03); }
        #copy-button:not(:disabled)::before { display: block; }
        #copy-button.copied { background: var(--accent); box-shadow: 0 4px 20px rgba(255, 0, 170, 0.5); }
        #copy-button.copied > .material-icons { animation: spin 0.5s ease-in-out; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* === STATUS MESSAGE === */
        .status-message { color: var(--success); text-align: center; margin-top: 1rem; font-size: 0.95rem; min-height: 1.5rem; height: auto; transition: all 0.3s ease; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: rgba(0, 255, 136, 0.1); padding: 0.8rem 1rem; border-radius: var(--border-radius); border-left: 4px solid var(--success); opacity: 0; visibility: hidden; max-height: 0; overflow: hidden; } .status-message.show { opacity: 1; visibility: visible; max-height: 100px; } .status-message.error { color: var(--error); border-left-color: var(--error); background: rgba(255, 61, 113, 0.1); } .status-message.info { color: var(--warning); border-left-color: var(--warning); background: rgba(255, 204, 0, 0.1); } .status-message .material-icons { font-size: 1.3rem; }

        /* === ICONS === */
        .material-icons { font-family: 'Material Icons'; font-weight: normal; font-style: normal; font-size: 20px; line-height: 1; letter-spacing: normal; text-transform: none; display: inline-block; white-space: nowrap; word-wrap: normal; direction: ltr; -webkit-font-feature-settings: 'liga'; -webkit-font-smoothing: antialiased; vertical-align: middle; user-select: none; }

        /* === MODAL STYLE === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(5, 5, 16, 0.9); backdrop-filter: blur(10px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
        .modal-overlay.hidden { display: none !important; }
        .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--bg-dark); border: 1px solid var(--secondary); border-radius: var(--border-radius); padding: 2.5rem; max-width: 600px; width: 90%; box-shadow: 0 0 50px rgba(110, 0, 255, 0.35); position: relative; animation: scaleInModal 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scale(1); }
        .modal-overlay:not(.hidden).initial-state .modal-content { transform: scale(0.9); opacity: 0;}
        @keyframes scaleInModal { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { color: var(--primary); text-align: center; margin-bottom: 1.5rem; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 0.5rem; } .modal-title .material-icons { font-size: 1.8rem; color: var(--primary); }
        .modal-message { color: var(--text-light); margin-bottom: 2rem; line-height: 1.7; font-size: 1rem; }
        .modal-message p { margin-bottom: 1rem; } .modal-message strong { color: var(--warning); }
        .modal-message code { background: var(--bg-lighter); color: var(--accent); padding: 0.2em 0.5em; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85em; word-break: break-all; display: inline-block; max-width: 100%; overflow-wrap: break-word; vertical-align: middle; margin-left: 0.3rem; border: 1px solid var(--md-border); }
        .modal-message i.material-icons { font-size: 1.1rem !important; vertical-align: text-bottom; margin-right: 0.3rem;}
        .modal-button { border: none; padding: 1rem; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0, 0.3); }
        .modal-button:hover:not(:disabled) { transform: translateY(-3px) scale(1.03); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5); }
        #gen-warning-confirm { background: linear-gradient(135deg, var(--success), #00ffaa); color: var(--bg-darker); box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4); }
        #gen-warning-confirm:hover { box-shadow: 0 6px 25px rgba(0, 255, 136, 0.6); }
        #final-warning-confirm { background: linear-gradient(135deg, var(--error), #ff6b8b); color: white; box-shadow: 0 4px 15px rgba(255, 61, 113, 0.4); }
        #final-warning-confirm:hover { box-shadow: 0 6px 25px rgba(255, 61, 113, 0.6); }
        #huan-error-confirm { background: linear-gradient(135deg, var(--warning), #ffd54f); color: var(--bg-darker); box-shadow: 0 4px 15px rgba(255, 204, 0, 0.4); }
        #huan-error-confirm:hover { box-shadow: 0 6px 25px rgba(255, 204, 0, 0.6); }
        .modal-button .material-icons { font-size: 1.4rem; }

        /* === RESPONSIVE DESIGN === */
        @media (max-width: 768px) { .container { margin: 1rem; padding: 1.5rem; animation: none; } h1 { font-size: 1.5rem; } textarea#markdown-input { min-height: 150px; padding: 1rem; } input[type="text"]#output-password-input, input[type="url"], select#image-layout-select, input[type="number"] { padding: 0.8rem 1rem; font-size: 0.95rem; } button { padding: 0.8rem; font-size: 0.9rem; } .modal-content { padding: 1.5rem; max-width: 95%; } .modal-title { font-size: 1.3rem; } .modal-message { font-size: 0.95rem;} .input-list { max-height: 200px;} .expiry-inputs { grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 0.6rem;} .layout-mode-selector { flex-direction: column; align-items: flex-start;} }
        @media (max-width: 480px) { body { padding: 1rem 0.5rem; } .container { padding: 1.2rem; margin: 0.5rem;} h1 { font-size: 1.3rem; } .input-group label { font-size: 0.85rem; } textarea#markdown-input, input, select#image-layout-select, input[type="number"] { font-size: 0.9rem;} .modal-message code { font-size: 0.8em;} small.input-note { font-size: 0.85rem; } .add-button { width: 100%; justify-content: center;} .input-list { padding-right: 5px;} .input-list-item input[type="url"] {font-size: 0.9rem; padding: 0.7rem 1rem;} .input-list-item button {padding: 0.5rem; min-width: 35px;} .expiry-inputs { grid-template-columns: repeat(3, 1fr); } .expiry-inputs .input-group:nth-child(4), .expiry-inputs .input-group:nth-child(5) { grid-column: span 1; } }

        /* Animation cho vi·ªác x√≥a item trong list */
        @keyframes slideOut {
             from { opacity: 1; transform: translateX(0); max-height: 50px; margin-bottom: 0.8rem; padding: auto;}
             to { opacity: 0; transform: translateX(20px); max-height: 0; margin-bottom: 0; padding: 0; border: 0; }
         }
        .input-list-item.removing {
            animation: slideOut 0.3s ease-out forwards;
         }

         /* Styles for Expiration Message on Target Page */
         #expiration-message {
            display: none; /* Hidden by default */
            padding: 2rem 1.5rem;
            margin: 1rem; /* Add some margin */
            border-radius: var(--border-radius);
            background-color: var(--expired-bg);
            border: 1px solid var(--expired-color);
            box-shadow: 0 0 20px rgba(255, 61, 113, 0.3);
            text-align: center;
            color: var(--expired-color);
            font-size: 1.3rem;
            font-weight: bold;
            line-height: 1.6;
            max-width: 600px;
            width: calc(100% - 2rem); /* Take full width minus margin */
            animation: fadeInExpired 0.8s ease-out;
            /* NEW: Center using flex on body */
            position: relative; /* Needed for z-index if overlapping */
         }
         #expiration-message .material-icons {
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
            color: var(--expired-color);
         }
         @keyframes fadeInExpired {
             from { opacity: 0; transform: translateY(20px) scale(0.95); }
             to { opacity: 1; transform: translateY(0) scale(1); }
         }
         /* Hide container when expired message is shown */
         body.expired .container {
             display: none !important;
         }
         /* Ensure expiration message is shown correctly */
         body.expired #expiration-message {
             display: block; /* Or flex if needed for internal centering */
         }
         /* Ensure body alignment works for expiration message */
         body.expired {
             align-items: center; /* Re-center vertically when expired */
             justify-content: center; /* Re-center horizontally when expired */
         }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="particles-container" id="particles"></div>
    <div class="grid-overlay"></div>
    <div class="scanlines"></div>
    <div class="glow-effect"></div>

    <!-- Generator Container -->
    <div class="container" id="generator-container">
        <h1><i class="material-icons">security</i> M√£ H√≥a & Nh√∫ng Media ƒêa NƒÉng v2.2</h1>
        <form class="generator-form" id="main-form" onsubmit="return false;">
            <!-- N·ªôi dung v√† M·∫≠t kh·∫©u -->
            <div class="input-group">
                <label for="markdown-input"><i class="material-icons">description</i> N·ªôi Dung Ch√≠nh (Markdown - T√πy ch·ªçn):</label>
                <textarea id="markdown-input" placeholder="Nh·∫≠p n·ªôi dung Markdown v√†o ƒë√¢y... **C√¢u h·ªèi?**&#10;    **Tr·∫£ l·ªùi ƒë√∫ng.**&#10;*   **Gi·∫£i th√≠ch (s·∫Ω ·∫©n/hi·ªán)...**"></textarea>
                 <small class="input-note"><i class="material-icons">lightbulb</i> M·∫πo Study Mode: D√πng `**C√¢u h·ªèi**`, th·ª•t ƒë·∫ßu d√≤ng `    **ƒê√°p √°n ƒë√∫ng**`, d√≤ng ti·∫øp `*   **Gi·∫£i th√≠ch**`.</small>
            </div>
             <!-- NEW: Layout Mode Selection -->
             <div class="input-group">
                <label><i class="material-icons">palette</i> Ch·ªçn B·ªë C·ª•c Hi·ªÉn Th·ªã:</label>
                <div class="layout-mode-selector">
                    <label for="layout-normal">
                        <input type="radio" id="layout-normal" name="page-layout" value="normal" checked> B√¨nh th∆∞·ªùng
                    </label>
                    <label for="layout-study">
                        <input type="radio" id="layout-study" name="page-layout" value="study"> Study Mode ‚ú®
                    </label>
                </div>
                 <small class="input-note"><i class="material-icons">help_outline</i> Study Mode s·∫Ω bi·∫øn `**C√¢u h·ªèi?**`, `    **ƒê√°p √°n**`, `*   **Gi·∫£i th√≠ch**` th√†nh d·∫°ng H·ªèi-ƒê√°p t∆∞∆°ng t√°c.</small>
             </div>
            <div class="input-group">
                <label for="output-password-input"><i class="material-icons">key</i> ƒê·∫∑t M·∫≠t Kh·∫©u B·∫£o M·∫≠t (B·∫Øt bu·ªôc):</label>
                <input type="text" id="output-password-input" placeholder="√çt nh·∫•t 8 k√Ω t·ª±, b·∫£o m·∫≠t m·∫°nh!" required minlength="8">
            </div>

            <!-- Expiry Date Input Section -->
            <div class="input-group">
                 <label><i class="material-icons">timer_off</i> ƒê·∫∑t Th·ªùi Gian H·∫øt H·∫°n (T√πy ch·ªçn):</label>
                 <div class="expiry-inputs">
                     <div class="input-group">
                         <label for="expiry-day"><i class="material-icons">calendar_today</i> Ng√†y:</label>
                         <input type="number" id="expiry-day" placeholder="DD" min="1" max="31">
                     </div>
                     <div class="input-group">
                         <label for="expiry-month"><i class="material-icons">calendar_month</i> Th√°ng:</label>
                         <input type="number" id="expiry-month" placeholder="MM" min="1" max="12">
                     </div>
                     <div class="input-group">
                         <label for="expiry-year"><i class="material-icons">event</i> NƒÉm:</label>
                         <input type="number" id="expiry-year" placeholder="YYYY" min="2024">
                     </div>
                     <div class="input-group">
                         <label for="expiry-hour"><i class="material-icons">schedule</i> Gi·ªù:</label>
                         <input type="number" id="expiry-hour" placeholder="HH" min="0" max="23">
                     </div>
                     <div class="input-group">
                         <label for="expiry-minute"><i class="material-icons">timer</i> Ph√∫t:</label>
                         <input type="number" id="expiry-minute" placeholder="MM" min="0" max="59">
                     </div>
                 </div>
                 <small class="input-note"><i class="material-icons">info_outline</i> ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·∫∑t h·∫°n. Ph·∫£i l√† th·ªùi ƒëi·ªÉm trong t∆∞∆°ng lai.</small>
            </div>

            <!-- Khu v·ª±c qu·∫£n l√Ω link ·∫£nh -->
            <div class="input-group">
                 <label for="image-url-list"><i class="material-icons">collections</i> Danh S√°ch Link ·∫¢nh (Nh√∫ng th√™m):</label>
                 <div class="input-list" id="image-url-list"></div>
                 <label for="image-layout-select" style="margin-top: 1rem;"><i class="material-icons">view_quilt</i> ƒê·ªãnh D·∫°ng Hi·ªÉn Th·ªã ·∫¢nh:</label>
                 <select id="image-layout-select">
                     <option value="grid">R·ªùi r·∫°c ngang (3 ·∫£nh/h√†ng)</option>
                     <option value="column">R·ªùi r·∫°c d·ªçc (1 ·∫£nh/h√†ng)</option>
                     <option value="comic">Comic (D√≠nh li·ªÅn, kh√¥ng click)</option>
                 </select>
                 <button type="button" class="add-button" id="add-image-button"><i class="material-icons">add_photo_alternate</i> Th√™m ·∫¢nh</button>
                 <small class="input-note"><i class="material-icons">info_outline</i> Th√™m link ·∫£nh tr·ª±c ti·∫øp. Hi·ªÉn th·ªã tr√™n n·ªôi dung ch√≠nh.</small>
            </div>

            <!-- Khu v·ª±c qu·∫£n l√Ω link iframe -->
             <div class="input-group">
                 <label for="iframe-url-list"><i class="material-icons">video_library</i> Danh S√°ch Link Iframe/Video:</label>
                 <div class="input-list" id="iframe-url-list"></div>
                  <button type="button" class="add-button" id="add-iframe-button"><i class="material-icons">add_link</i> Th√™m Iframe/Video</button>
                  <small class="input-note"><i class="material-icons">info_outline</i> D√°n link nh√∫ng (Youtube, Drive, Web,...). Hi·ªÉn th·ªã d∆∞·ªõi n·ªôi dung ch√≠nh.</small>
             </div>

            <!-- Buttons -->
            <button type="button" id="generate-button"><i class="material-icons">enhanced_encryption</i> T·∫°o M√£ Ngu·ªìn</button>
            <button type="button" id="copy-button" disabled><i class="material-icons">content_copy</i> Sao Ch√©p M√£ Ngu·ªìn</button>
            <div class="status-message" id="status-message"></div>
        </form>
    </div>

    <!-- Security Warning Modal (Cho Generator Page) -->
    <div class="modal-overlay hidden" id="warning-modal"></div>

    <script>
        // ====== CONFIGURATION & ELEMENTS ======
        const markdownInput = document.getElementById('markdown-input');
        const outputPasswordInput = document.getElementById('output-password-input');
        // NEW: Layout Mode Radios
        const layoutNormalRadio = document.getElementById('layout-normal');
        const layoutStudyRadio = document.getElementById('layout-study');
        const expiryDayInput = document.getElementById('expiry-day');
        const expiryMonthInput = document.getElementById('expiry-month');
        const expiryYearInput = document.getElementById('expiry-year');
        const expiryHourInput = document.getElementById('expiry-hour');
        const expiryMinuteInput = document.getElementById('expiry-minute');
        const expiryInputs = [expiryDayInput, expiryMonthInput, expiryYearInput, expiryHourInput, expiryMinuteInput];
        const imageUrlList = document.getElementById('image-url-list');
        const iframeUrlList = document.getElementById('iframe-url-list');
        const addImageButton = document.getElementById('add-image-button');
        const addIframeButton = document.getElementById('add-iframe-button');
        const imageLayoutSelect = document.getElementById('image-layout-select');
        const generateButton = document.getElementById('generate-button');
        const copyButton = document.getElementById('copy-button');
        const statusMessage = document.getElementById('status-message');
        const warningModal = document.getElementById('warning-modal');
        const particlesContainer = document.getElementById('particles');
        let fullHtmlToCopy = '';
        let statusTimeout = null;

        // ====== UTILITY FUNCTIONS ======
        function createParticles(container) { if (!container) return; if (container.children.length > 50 && Math.random() < 0.95) return; const currentCount = container.children.length; const maxParticles = window.innerWidth > 768 ? 150 : 75; const particlesToAdd = Math.max(0, maxParticles - currentCount); if (particlesToAdd === 0 && Math.random() < 0.9) return; if (particlesToAdd < maxParticles * 0.5 && currentCount > 0) {} else { container.innerHTML = ''; } for (let i = 0; i < Math.min(particlesToAdd, 30); i++) { const p = document.createElement('div'); p.classList.add('particle'); const s = Math.random() * 5 + 1.5; const x = Math.random() * window.innerWidth; const d = Math.random() * 10; const u = Math.random() * 15 + 10; const o = Math.random() * 0.5 + 0.1; Object.assign(p.style, { width: `${s}px`, height: `${s}px`, left: `${x}px`, bottom: `-${s}px`, animationDuration: `${u}s`, animationDelay: `${d}s`, opacity: o }); const c = ['#00f7ff', '#6e00ff', '#ff00aa', '#00ff88', '#ffffff'][Math.floor(Math.random() * 5)]; p.style.background = `radial-gradient(circle, ${c} 0%, transparent 70%)`; container.appendChild(p); } }
        function showStatus(message, type = "info", icon = "info", duration = 5000) { clearTimeout(statusTimeout); statusMessage.innerHTML = `<i class="material-icons">${icon}</i> ${message}`; statusMessage.className = 'status-message'; requestAnimationFrame(() => { statusMessage.classList.add(type); statusMessage.classList.add('show'); }); if (duration > 0) { statusTimeout = setTimeout(() => { statusMessage.classList.remove('show'); }, duration); } }
        function isValidUrl(string) { if (!string) return false; try { new URL(string); return string.startsWith('http:') || string.startsWith('https:') || string.startsWith('data:'); } catch (_) { return false; } }

        // ====== Dynamic Input List Logic ======
        function addListItem(listContainer, placeholderText = "D√°n URL...") {
             const listItem = document.createElement('div');
             listItem.className = 'input-list-item';
             const input = document.createElement('input');
             input.type = 'url'; input.placeholder = placeholderText; input.addEventListener('input', () => input.classList.remove('error'));
             const removeButton = document.createElement('button'); removeButton.type = 'button'; removeButton.innerHTML = '<i class="material-icons" style="font-size: 1.1rem; line-height: 1;">delete_forever</i>'; removeButton.title = 'X√≥a link n√†y';
             removeButton.onclick = () => { listItem.classList.add('removing'); listItem.addEventListener('animationend', () => listItem.remove(), { once: true }); };
             listItem.appendChild(input); listItem.appendChild(removeButton); listContainer.appendChild(listItem); input.focus(); listContainer.scrollTop = listContainer.scrollHeight;
        }
        addImageButton.addEventListener('click', () => addListItem(imageUrlList, "D√°n link ·∫£nh tr·ª±c ti·∫øp..."));
        addIframeButton.addEventListener('click', () => addListItem(iframeUrlList, "D√°n link nh√∫ng iframe/video..."));

        // ====== SECURITY FUNCTIONS ======
        function multiLayerEncrypt(content, password, layers = 10) {
            if (typeof CryptoJS === 'undefined') throw new Error("L·ªói: CryptoJS ch∆∞a t·∫£i.");
            let currentContent = content;
            for (let i = 0; i < layers; i++) {
                const combined = `${currentContent}|${password}|${i}`; const layerKey = password + i;
                try { currentContent = CryptoJS.AES.encrypt(combined, layerKey).toString(); }
                catch (e) { throw new Error(`L·ªói m√£ h√≥a AES l·ªõp ${i + 1}: ${e.message || e}`); }
            } return currentContent;
        }

        // ====== HTML TEMPLATE GENERATION (REVISED v2.2 - MODIFIED TO REMOVE HINT & ADD FREESOS) ======
        function generateTargetHtmlTemplate(markdownContentHtml, pagePassword, pageLayoutMode = 'normal', imageLayout = 'grid', imageUrls = [], iframeUrls = [], expiryDetails = null) {
            let encryptedMarkdownHtml;
            try {
                const contentToEncrypt = markdownContentHtml || "";
                encryptedMarkdownHtml = multiLayerEncrypt(contentToEncrypt, pagePassword, 10);
            } catch (e) { throw new Error(`M√£ h√≥a th·∫•t b·∫°i: ${e.message}`); }

            const escapedEncryptedData = encryptedMarkdownHtml.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
            const escapedPageLayoutMode = pageLayoutMode.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
            const escapedImageLayout = imageLayout.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
            const imageUrlsJs = JSON.stringify(imageUrls);
            const iframeUrlsJs = JSON.stringify(iframeUrls);
            const expiryDetailsJs = expiryDetails ? JSON.stringify(expiryDetails) : 'null';
            // Store original password encoded for admin/freesos bypass decryption
            const adminEncodedPassJs = `'${btoa(pagePassword)}'`;

            // --- REMOVED adminAccessInfo GENERATION ---
            // const adminKeyTripleEncoded = btoa(btoa(btoa('admin')));
            // const adminAccessInfo = `üîë ƒê·ªÉ b·ªè qua...`; // Removed

            const donateMessage = `ü§´ Qu√™n m·∫≠t kh·∫©u? ƒê√¥n n·∫øt nh·∫π <strong>10K</strong> v√†o Momo/ZaloPay <strong>0901574726</strong>, nh·∫Øn v·∫•n ƒë·ªÅ v√† t·ªõ s·∫Ω c·ªë g·∫Øng gi√∫p! üòâ`;
            const hu·∫•nQuote = `Sau nay, ch·ªâ c√≥ l√†m ch·ªãu kh√≥ c·∫ßn c√π th√¨ b√π si√™ng nƒÉng,... C√°i lo·∫°i xem ch√πa m√† ƒë√≤i free th√¨ ƒÉn c√°m<br><strong style="font-style:normal;font-weight:bold;font-size:1.1em;">| -_- |</strong>`;
            const expiredMessage = `√îi kh√¥ng, v·∫≠n may c·ªßa b·∫°n ƒë√£ h·∫øt. File ƒë√£ h·∫øt h·∫°n r√πi!!!`;

            // --- TARGET HTML TEMPLATE (REVISED STRUCTURE & CSS v2.2) ---
            return `
<html lang="vi">
<head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>N·ªôi Dung B·∫£o M·∫≠t & Media ƒêa NƒÉng v2.2</title> <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"><\/script> <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
/* === ROOT VARIABLES (Added Study Mode) === */
:root{--primary:#00f7ff;--secondary:#6e00ff;--accent:#ff00aa;--error:#ff3d71;--success:#00ff88;--warning:#ffcc00;--bg-dark:#0a0a20;--bg-darker:#050510;--bg-light:rgba(20,20,50,.5);--bg-lighter:rgba(30,30,70,.3);--text-light:#e0e0ff;--text-lighter:#fff;--text-dim:rgba(224,224,255,.6);--border-radius:12px;--box-shadow:0 0 30px rgba(0,247,255,.2);--transition:all .4s cubic-bezier(.175,.885,.32,1.275);--iframe-border:rgba(0,247,255,.3);--iframe-bg:rgba(10,10,32,.7);--md-border:rgba(110,0,255,.25);--code-bg:rgba(0,10,30,.8);--expired-color:var(--error);--expired-bg:rgba(255,61,113,.1); --study-question-border: rgba(0, 247, 255, 0.5);--study-question-bg: rgba(0, 100, 120, 0.1);--study-answer-color: var(--success);--study-explanation-bg: rgba(110, 0, 255, 0.1);--study-explanation-border: var(--secondary); }
/* === BASE STYLES === */
*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:var(--bg-dark);color:var(--text-light);min-height:100vh;overflow-x:hidden;line-height:1.6;position:relative;display:flex;align-items:center; /* Default center alignment */ justify-content:center;padding:2rem 1rem}
/* === BACKGROUND EFFECTS === */
.particles-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;overflow:hidden; pointer-events: none;}
.particle{position:absolute;background:radial-gradient(circle,var(--primary) 0%,transparent 70%);border-radius:50%;opacity:.6;animation:particle-anim linear infinite} @keyframes particle-anim{0%{transform:translateY(0) rotate(0deg);opacity:0}10%{opacity:.6}100%{transform:translateY(-1500px) rotate(720deg);opacity:0}}
.grid-overlay,.scanlines,.glow-effect{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none}
.grid-overlay{background-image:linear-gradient(rgba(110,0,255,.05) 1px,transparent 1px),linear-gradient(90deg,rgba(110,0,255,.05) 1px,transparent 1px);background-size:40px 40px}
.scanlines{background:repeating-linear-gradient(0deg,rgba(0,247,255,.03),rgba(0,247,255,.03) 1px,transparent 1px,transparent 3px);animation:scanline 8s linear infinite} @keyframes scanline{0%{background-position:0 0}100%{background-position:0 100%}}
.glow-effect{background:radial-gradient(circle at center,rgba(0,247,255,.05) 0%,transparent 70%);animation:pulse 8s infinite alternate} @keyframes pulse{0%{opacity:.3;transform:scale(.95)}100%{opacity:.7;transform:scale(1.05)}}
/* === TARGET PAGE CONTAINER === */
.container{max-width:1000px; width:100%;margin:auto; /* Changed margin for centering */ padding:2rem 2.5rem 3rem 2.5rem;background:rgba(10,10,32,.9);backdrop-filter:blur(12px);border-radius:var(--border-radius);box-shadow:var(--box-shadow);border:1px solid rgba(110,0,255,.3);position:relative;overflow:visible;transition:var(--transition);animation:floatTarget 7s ease-in-out infinite}
@keyframes floatTarget{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.container::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at center,rgba(0,247,255,.1) 0%,transparent 60%);z-index:-1;animation:pulse 15s infinite alternate}
/* === PASSWORD SECTION === */
.page-title{text-align:center;color:var(--primary);margin-bottom:2rem;font-weight:300;letter-spacing:2px;text-transform:uppercase;font-size:1.6rem;text-shadow:0 0 15px rgba(0,247,255,.5);position:relative;padding-bottom:1rem;display:flex;align-items:center;justify-content:center;gap:.7rem}.page-title .material-icons{font-size:2rem}.page-title::after{content:'';position:absolute;bottom:0;left:30%;width:40%;height:2px;background:linear-gradient(90deg,transparent,var(--primary),transparent)}
.final-page-password-form{display:flex;flex-direction:column;gap:1.5rem;margin-top:2rem;max-width:400px;margin-left:auto;margin-right:auto}
#final-password-section{transition:opacity .5s ease,transform .5s ease,padding .6s ease,margin .6s ease,visibility 0s linear .6s; overflow:hidden;visibility:visible;padding:1rem 0;margin-bottom:2rem;}
#final-password-section.hidden{display: none !important;} /* Simple hide for admin/freesos */
#final-password-section.hiding{opacity:0;transform:scale(.9);pointer-events:none; padding-top:0;padding-bottom:0;margin-bottom:0;visibility:hidden; transition-delay: 0s !important;}
.final-page-input-group label{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;color:var(--text-light);font-size:.9rem;letter-spacing:1px;text-transform:uppercase}.final-page-input-group label .material-icons{color:var(--secondary);font-size:1.2rem}
.final-page-input-group input[type=password]{width:100%;padding:1rem 1.5rem;background:var(--bg-light);border:1px solid rgba(110,0,255,.5);border-radius:var(--border-radius);color:var(--text-light);font-size:1.1rem;transition:var(--transition);outline:none;letter-spacing:3px;font-family:'Courier New',Courier,monospace}.final-page-input-group input[type=password]:focus{border-color:var(--primary);box-shadow:0 0 15px rgba(0,247,255,.5);transform:translateY(-2px)}
.final-page-button{background:linear-gradient(135deg,var(--secondary),var(--primary));color:#fff;border:none;padding:1rem;border-radius:var(--border-radius);cursor:pointer;font-size:1rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;transition:var(--transition);box-shadow:0 4px 20px rgba(110,0,255,.4);position:relative;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;gap:.5rem}.final-page-button:hover:not(:disabled){transform:translateY(-3px) scale(1.03);box-shadow:0 6px 25px rgba(0,247,255,.6)}.final-page-button:disabled{filter:grayscale(70%);opacity:.6;cursor:not-allowed;box-shadow:none;transform:none!important}.final-page-button::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(to bottom right,rgba(255,255,255,0) 0%,rgba(255,255,255,.1) 50%,rgba(255,255,255,0) 100%);transform:rotate(45deg);animation:shine 3s infinite linear;opacity:.5; pointer-events: none;}@keyframes shine{0%{transform:translateX(-150%) rotate(45deg)}100%{transform:translateX(150%) rotate(45deg)}}
.final-page-error-message{color:var(--error);text-align:center;margin-top:.5rem;margin-bottom:-.5rem;font-size:.95rem;min-height:2.5rem;font-weight:700;display:flex;align-items:center;justify-content:center;gap:.4rem;opacity:0;transition:opacity .3s ease, max-height 0.3s ease;padding:.5rem .8rem;background:rgba(255,61,113,.1);border-left:3px solid var(--error);border-radius:4px;line-height:1.4;overflow: hidden; max-height: 0;}
.final-page-error-message.show{opacity:1; max-height: 100px;}
.final-page-input-group input[type=password].shake{animation:shake-final .5s cubic-bezier(.36,.07,.19,.97) both;border-color:var(--error)}@keyframes shake-final{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-6px)}20%,40%,60%,80%{transform:translateX(6px)}}
.final-page-donation-prompt{text-align:center;margin-top:1.5rem;padding:.8rem 1rem;background:rgba(255,204,0,.1);border-left:4px solid var(--warning);border-radius:var(--border-radius);color:var(--warning);font-size:.9rem;line-height:1.5;font-style:italic}.final-page-donation-prompt strong{font-weight:700;color:var(--text-lighter)}
.final-page-donation-prompt code { background: rgba(0,0,0,0.2); color: var(--primary); padding: 0.1em 0.4em; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 0.9em; margin: 0 0.1em; }

/* === CONTENT SECTION === */
#final-content-section{opacity:0;visibility:hidden;overflow: hidden;transition: opacity .6s ease-out, visibility 0s linear .6s;position: relative;}
#final-content-section.visible{opacity:1;visibility:visible;overflow: visible;transition: opacity .6s ease-out .2s, visibility 0s linear 0s;}
#final-content-section.visible>*{animation:fadeInChild .7s ease-out forwards;opacity:0}
#final-content-section.visible > #embedded-images-container { animation-delay: .1s; }
#final-content-section.visible > #final-markdown-content { animation-delay: .3s; }
#final-content-section.visible > #embedded-iframes-container { animation-delay: .5s; }
#final-content-section.visible > .footer-note { animation-delay: .7s }
@keyframes fadeInChild{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* === STYLES FOR MULTIPLE MEDIA === */
#embedded-images-container {margin-bottom: 2.5rem;display: grid;gap: 1.5rem;grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));}
#embedded-images-container.layout-grid {display: grid;gap: 1.5rem;grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));}
@media (min-width: 600px) { #embedded-images-container.layout-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); } }
@media (min-width: 900px) { #embedded-images-container.layout-grid { grid-template-columns: repeat(3, 1fr); } }
#embedded-images-container.layout-column {display: flex;flex-direction: column;gap: 1.5rem;align-items: center;}
#embedded-images-container.layout-column .embedded-image-item {width: 100%;max-width: 600px;}
#embedded-images-container.layout-comic {display: flex;flex-wrap: wrap;gap: 0;margin-bottom: 2.5rem;}
#embedded-images-container.layout-comic .embedded-image-item {flex: 1 1 auto;border: none;border-radius: 0;box-shadow: none;margin: 0;overflow: hidden;min-width: 50px;}
#embedded-images-container.layout-comic .embedded-image-item img {border-radius: 0;cursor: default !important;transition: none;}
#embedded-images-container.layout-comic .embedded-image-item img:hover {transform: none;filter: none;box-shadow: none;}
.embedded-image-item {border-radius: var(--border-radius);overflow: hidden;box-shadow: 0 10px 30px rgba(0, 247, 255, 0.15);border: 1px solid var(--iframe-border);position: relative;background-color: var(--bg-lighter);transition: var(--transition);}
.embedded-image-item img {display: block;width: 100%;height: auto;border-radius: calc(var(--border-radius) - 1px);opacity: 0;transition: opacity .5s ease-in .1s, transform .3s ease;cursor: pointer;}
.embedded-image-item img.loaded { opacity: 1; }
.embedded-image-item img:hover {transform: scale(1.05);filter: brightness(1.1);box-shadow: 0 5px 15px rgba(0, 247, 255, 0.3);}
.media-error-message { padding: 1.5rem; text-align: center; color: var(--error); font-size: 1rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: .5rem; min-height: 100px; background-color: rgba(255, 61, 113, 0.1); } .media-error-message .material-icons { font-size: 1.5rem; }
#embedded-iframes-container {margin-top: 3rem; display: grid; gap: 2rem; grid-template-columns: 1fr; }
@media (min-width: 900px) {#embedded-iframes-container { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }}
.iframe-item-wrapper { border: 1px solid var(--iframe-border); border-radius: var(--border-radius); overflow: hidden; background-color: var(--iframe-bg); box-shadow: 0 10px 30px rgba(0, 247, 255, 0.2); position: relative; width: 100%; padding-top: 56.25%; transition: var(--transition); }
.iframe-item-wrapper:hover { box-shadow: 0 12px 40px rgba(0, 247, 255, 0.35); transform: translateY(-5px); }
.iframe-item-wrapper iframe {position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: calc(var(--border-radius) - 1px); }

/* === MARKDOWN STYLES === */
.final-template-styles{line-height:1.75;color:var(--text-light);max-width:100%;margin-bottom:3rem}.final-template-styles>:first-child{margin-top:0!important}.final-template-styles>:last-child{margin-bottom:0!important}.final-template-styles h1,.final-template-styles h2,.final-template-styles h3,.final-template-styles h4,.final-template-styles h5,.final-template-styles h6{color:var(--primary);margin-top:2rem;margin-bottom:1rem;font-weight:400;letter-spacing:1px;padding-bottom:.6rem;border-bottom:1px solid var(--md-border);position:relative;text-shadow:0 0 8px rgba(0,247,255,.2)}.final-template-styles h1::after,.final-template-styles h2::after{content:'';position:absolute;bottom:-1px;left:0;height:3px;width:80px;background:linear-gradient(90deg,var(--accent),var(--secondary));border-radius:3px;transition:width .4s ease-in-out}.final-template-styles h1:hover::after,.final-template-styles h2:hover::after{width:120px}.final-template-styles h1{font-size:2.1rem;letter-spacing:1.5px}.final-template-styles h2{font-size:1.7rem;color:var(--accent)}.final-template-styles h3{font-size:1.4rem;color:var(--success);border-bottom-style:dashed}.final-template-styles h4{font-size:1.2rem;color:var(--warning);border:none;padding-bottom:0;margin-bottom:.5rem;font-weight:500}.final-template-styles h5,.final-template-styles h6{font-size:1.1rem;color:var(--text-dim);font-weight:600;border:none;padding-bottom:0;margin-bottom:.5rem;text-transform:uppercase}.final-template-styles p{margin-bottom:1.1rem;font-size:1.05rem}.final-template-styles a{color:var(--accent);text-decoration:none;position:relative;padding-bottom:2px;transition:color .3s ease,text-shadow .3s ease;font-weight:600;overflow:hidden;display:inline-block}.final-template-styles a::after{content:'';position:absolute;bottom:-2px;left:0;width:100%;height:2px;background:var(--primary);transform:scaleX(0);transform-origin:left;transition:transform .4s cubic-bezier(.19,1,.22,1)}.final-template-styles a:hover{color:var(--primary);text-shadow:0 0 10px var(--primary)}.final-template-styles a:hover::after{transform:scaleX(1)}.final-template-styles ol,.final-template-styles ul{margin-left:1.5rem;margin-bottom:1.1rem;padding-left:1.8rem;list-style:none}.final-template-styles li{margin-bottom:.6rem;position:relative;padding-left:.5rem}.final-template-styles ul li::before{content:'‚ú®';color:var(--primary);font-weight:400;display:inline-block;width:1em;margin-left:-1.5em;font-size:1.2em;line-height:1;position:absolute;top:.25em;left:0;text-shadow:0 0 6px var(--primary);transition:transform .3s ease}.final-template-styles ul li:hover::before{transform:rotate(90deg) scale(1.2)}.final-template-styles ol{counter-reset:list-counter}.final-template-styles ol li{counter-increment:list-counter}.final-template-styles ol li::before{content:counter(list-counter);color:var(--secondary);font-weight:700;font-size:.85em;font-family:'Georgia',serif;display:inline-flex;align-items:center;justify-content:center;width:1.8em;height:1.8em;margin-left:-1.8em;margin-right:.5em;background-color:rgba(110,0,255,.15);border-radius:50%;border:1px solid var(--secondary);position:absolute;top:.15em;left:0;line-height:1.8em;box-shadow:0 0 5px rgba(110,0,255,.3);transition:background-color .3s ease,transform .3s ease}.final-template-styles ol li:hover::before{background-color:rgba(110,0,255,.4);transform:scale(1.1)}.final-template-styles li p{margin-bottom:.3rem}.final-template-styles blockquote{position:relative;border:none;border-left:6px solid;border-image:linear-gradient(to bottom,var(--secondary),var(--primary)) 1;padding:1.5rem 2rem 1.5rem 3.5rem;margin:2rem 0;background:linear-gradient(135deg,rgba(110,0,255,.08),rgba(110,0,255,.2));border-radius:0 var(--border-radius) var(--border-radius) 0;font-style:italic;font-size:1.1em;color:var(--text-lighter);box-shadow:inset 5px 0 15px -5px rgba(110,0,255,.4);backdrop-filter:blur(2px)}.final-template-styles blockquote::before{content:'format_quote';font-family:'Material Icons';font-size:3rem;color:var(--secondary);opacity:.5;position:absolute;left:.8rem;top:.5rem;transform:translateY(-10%)}.final-template-styles blockquote p{margin-bottom:.6rem;font-size:1em}.final-template-styles blockquote p:last-child{margin-bottom:0}.final-template-styles code:not(pre code){background:rgba(0,247,255,.1);color:var(--primary);padding:.3em .6em;border-radius:5px;font-family:'Fira Code','Consolas',monospace;font-size:.9em;border:1px solid rgba(0,247,255,.3);word-break:break-word;text-shadow:0 0 3px rgba(0,247,255,.5)}.final-template-styles pre{background:var(--code-bg);padding:1.5rem 1.8rem;border-radius:var(--border-radius);overflow-x:auto;margin:2rem 0;border:1px solid var(--secondary);box-shadow:0 0 25px rgba(110,0,255,.25),inset 0 0 15px rgba(0,0,0,.6);position:relative}.final-template-styles pre code{background:0 0;padding:0;font-size:.95em;line-height:1.65;color:var(--text-light);font-family:'Fira Code','Consolas','Monaco',monospace}.final-template-styles pre::-webkit-scrollbar{height:8px;background-color:rgba(0,0,0,.2)}.final-template-styles pre::-webkit-scrollbar-thumb{background:linear-gradient(90deg,var(--secondary),var(--primary));border-radius:4px}.final-template-styles hr{border:0;height:2px;margin:3rem auto;width:70%;background:linear-gradient(90deg,transparent,var(--secondary) 20%,var(--primary) 80%,transparent);opacity:.6}.final-template-styles table{width:100%;border-collapse:separate;border-spacing:0;margin:2rem 0;background:0 0;border:1px solid var(--md-border);border-radius:var(--border-radius);box-shadow:0 8px 25px rgba(0,0,0,.4);overflow:hidden}.final-template-styles td,.final-template-styles th{border-bottom:1px solid var(--md-border);padding:1rem 1.2rem;text-align:left;transition:background-color .3s ease}.final-template-styles td{background-color:rgba(10,10,32,.5)}.final-template-styles tr:last-child td{border-bottom:none}.final-template-styles th{background:linear-gradient(135deg,rgba(110,0,255,.3),rgba(0,247,255,.3));color:var(--text-lighter);font-weight:700;text-transform:uppercase;font-size:.9em;letter-spacing:1px;border-bottom:2px solid var(--primary)}.final-template-styles td:first-child,.final-template-styles th:first-child{padding-left:1.5rem}.final-template-styles td:last-child,.final-template-styles th:last-child{padding-right:1.5rem}.final-template-styles tr:hover td{background-color:var(--bg-lighter);color:var(--text-lighter)}
.final-template-styles img{max-width:100%;height:auto;border-radius:8px;margin:1.5rem 0;box-shadow:0 8px 25px rgba(0,0,0,.4);border:1px solid var(--iframe-border);display:block;background:var(--bg-lighter);transition:transform .3s ease,box-shadow .3s ease,filter .3s ease}.final-template-styles img:hover{transform:scale(1.03);box-shadow:0 12px 40px rgba(0,247,255,.25);filter:brightness(1.1)}

/* === NEW: STUDY MODE STYLES === */
.final-template-styles.study-mode p, .final-template-styles.study-mode li { margin-bottom: 0.8rem; } /* Adjust spacing in study mode */
.final-template-styles.study-mode .study-question { border: 2px solid var(--study-question-border); border-radius: var(--border-radius); padding: 1.2rem 1.5rem; margin-bottom: 1rem; margin-top: 1.5rem; background-color: var(--study-question-bg); position: relative; overflow: hidden; }
.final-template-styles.study-mode .study-question strong { color: var(--primary); font-size: 1.1em; /* Make question text slightly larger */ }
.final-template-styles.study-mode .study-question::before { /* Optional decorative element */ content: 'Q:'; position: absolute; left: -10px; top: -5px; font-size: 4em; color: var(--study-question-border); opacity: 0.1; font-weight: bold; transform: rotate(-10deg); }
.final-template-styles.study-mode .study-answer { padding-left: 2.5rem !important; /* Indent answer */ position: relative; cursor: pointer; transition: color 0.3s ease; margin-top: 0.5rem; margin-bottom: 0.5rem; }
.final-template-styles.study-mode .study-answer::before { /* Icon indicating it's clickable */ content: 'check_circle_outline'; font-family: 'Material Icons'; position: absolute; left: 0.5rem; top: 0.1em; color: var(--study-answer-color); font-size: 1.3em; transition: transform 0.3s ease; }
.final-template-styles.study-mode .study-answer:hover::before { transform: scale(1.2); }
.final-template-styles.study-mode .study-answer strong { color: var(--study-answer-color); font-weight: bold; transition: text-shadow 0.3s ease; }
.final-template-styles.study-mode .study-answer:hover strong { text-shadow: 0 0 8px var(--study-answer-color); }
.final-template-styles.study-mode .study-explanation { display: none; /* Hidden by default */ background-color: var(--study-explanation-bg); border-left: 4px solid var(--study-explanation-border); border-radius: 0 8px 8px 0; padding: 0.8rem 1.2rem 0.8rem 1.5rem; margin-left: 2.5rem; /* Align with answer indentation */ margin-top: 0.5rem; margin-bottom: 1rem; font-size: 0.95em; color: var(--text-dim); transition: opacity 0.4s ease; }
.final-template-styles.study-mode .study-explanation.visible { display: block; animation: fadeInExplanation 0.5s ease; }
.final-template-styles.study-mode .study-explanation em { font-style: normal; } /* Remove default italic if needed */
.final-template-styles.study-mode .study-explanation strong { color: var(--warning); /* Highlight explanation keyword if any */ }
.final-template-styles.study-mode .study-explanation p:last-child { margin-bottom: 0; }
@keyframes fadeInExplanation { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
/* Adjust default list styles slightly for study mode if needed */
.final-template-styles.study-mode ul li::before,
.final-template-styles.study-mode ol li::before {
   /* Maybe hide default bullets if answer/explanation replaces them */
   /* display: none; */
   top: 0.4em; /* Adjust vertical alignment */
}
.final-template-styles.study-mode ul, .final-template-styles.study-mode ol {
    padding-left: 1rem; /* Reduce padding if using custom markers */
    margin-left: 0;
}


/* === MODAL STYLE === */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(5,5,16,.9);backdrop-filter:blur(10px);z-index:1000;display:flex;justify-content:center;align-items:center;opacity:0;transition:opacity .5s ease;pointer-events:none}.modal-overlay.hidden{display:none!important}.modal-overlay:not(.hidden){opacity:1;pointer-events:auto}
.modal-content{background:var(--bg-dark);border:1px solid var(--secondary);border-radius:var(--border-radius);padding:2.5rem;max-width:600px;width:90%;box-shadow:0 0 50px rgba(110,0,255,.35);position:relative;animation:scaleInModal .5s cubic-bezier(.175,.885,.32,1.275);transform:scale(1)}.modal-overlay:not(.hidden).initial-state .modal-content{transform:scale(.9);opacity:0}@keyframes scaleInModal{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
.modal-title{color:var(--primary);text-align:center;margin-bottom:1.5rem;font-size:1.5rem;text-transform:uppercase;letter-spacing:1px;display:flex;align-items:center;justify-content:center;gap:.5rem}.modal-title .material-icons{font-size:1.8rem; color: var(--primary)}
.modal-message{color:var(--text-light);margin-bottom:2rem;line-height:1.7;font-size:1.1rem;text-align:center}.modal-message p{margin-bottom:1rem}.modal-message strong{color:var(--warning)}
.modal-button{border:none;padding:1rem;border-radius:var(--border-radius);cursor:pointer;font-size:1rem;font-weight:700;width:100%;display:flex;align-items:center;justify-content:center;gap:.5rem;transition:var(--transition)}
#final-warning-confirm { background: linear-gradient(135deg, var(--error), #ff6b8b); color: white; box-shadow: 0 4px 15px rgba(255, 61, 113, 0.4); }
#final-warning-confirm:hover:not(:disabled) { box-shadow: 0 6px 25px rgba(255, 61, 113, 0.6); transform: translateY(-3px) scale(1.03); }
#huan-error-confirm { background: linear-gradient(135deg, var(--warning), #ffd54f); color: var(--bg-darker); box-shadow: 0 4px 15px rgba(255, 204, 0, 0.4); }
#huan-error-confirm:hover:not(:disabled) { box-shadow: 0 6px 25px rgba(255, 204, 0, 0.6); transform: translateY(-3px) scale(1.03); }
/* === MISC & FOOTER === */
.hidden{display:none!important;visibility:hidden}.text-center{text-align:center}
.footer-note{text-align:center;margin-top:3rem;font-size:.9rem;color:var(--text-dim);opacity:.8;letter-spacing:.5px}.footer-note .material-icons{font-size:1rem;vertical-align:middle;margin-right:.2rem}
.spin{animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}

/* === Expiration Message Style (Moved Outside Container) === */
 #expiration-message{
    display:none; /* Hidden by default */
    padding:2rem 1.5rem; margin: 1rem; border-radius:var(--border-radius);
    background-color:var(--expired-bg); border:1px solid var(--expired-color);
    box-shadow:0 0 20px rgba(255,61,113,.3); text-align:center; color:var(--expired-color);
    font-size:1.3rem; font-weight:700; line-height:1.6; max-width:600px;
    width: calc(100% - 2rem); animation:fadeInExpired .8s ease-out;
    position:relative; /* Ensure it's above background effects */ z-index: 1;
 }
 #expiration-message .material-icons{font-size:3rem;display:block;margin-bottom:1rem;color:var(--expired-color)}
 @keyframes fadeInExpired{from{opacity:0;transform:translateY(20px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}

 /* Hide container when expired message is shown */
 body.expired .container { display: none !important; }
 /* Ensure expiration message is shown correctly */
 body.expired #expiration-message { display: block; /* Or flex if needed */ }
 /* Ensure body alignment works for expiration message */
 body.expired { align-items: center; justify-content: center; }

/* === RESPONSIVE OVERRIDES === */
@media (max-width:768px){body{padding:1rem}.container{padding:1.5rem;margin:auto}.final-page-password-form{max-width:100%}.page-title{font-size:1.4rem}.final-template-styles h1{font-size:1.8rem}.final-template-styles h2{font-size:1.5rem}.final-template-styles blockquote{padding:1rem 1.5rem 1rem 2.5rem}.final-template-styles blockquote::before{left:.5rem;font-size:2.5rem}.final-template-styles pre{padding:1.2rem}.final-template-styles td,.final-template-styles th{padding:.8rem 1rem}.modal-content{padding:1.5rem;max-width:95%}.modal-title{font-size:1.3rem}.modal-message{font-size:1rem}
    #embedded-images-container { gap: 1rem; margin-bottom: 1.5rem; }
    #embedded-images-container.layout-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    #embedded-images-container.layout-column { gap: 1rem; }
    #embedded-iframes-container { margin-top: 2rem; gap: 1.5rem; }
    #expiration-message { font-size: 1.1rem; padding: 1.5rem 1rem;} #expiration-message .material-icons { font-size: 2.5rem; }}
@media (max-width:480px){.final-page-password-form{gap:1.2rem}.final-page-input-group input[type=password]{padding:.8rem 1rem;font-size:1rem}.page-title{font-size:1.3rem}.modal-title{font-size:1.2rem}.modal-message{font-size:.95rem;line-height:1.6}.final-template-styles h1{font-size:1.6rem}.final-template-styles h2{font-size:1.3rem}.final-template-styles h3{font-size:1.2rem}.final-template-styles code:not(pre code){font-size:.85em}.final-template-styles pre code{font-size:.9em}.final-template-styles table{font-size:.9rem}.final-template-styles td,.final-template-styles th{padding:.6rem .8rem}
    #embedded-images-container.layout-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
    #expiration-message { font-size: 1rem; }
    /* Study mode responsive */
    .final-template-styles.study-mode .study-question { padding: 1rem 1.2rem; }
    .final-template-styles.study-mode .study-answer { padding-left: 2rem !important; }
    .final-template-styles.study-mode .study-answer::before { left: 0.2rem; }
    .final-template-styles.study-mode .study-explanation { margin-left: 2rem; padding: 0.6rem 1rem 0.6rem 1.2rem; }
}
</style>
</head>
<body id="target-body">
    <div class="particles-container" id="final-particles"></div> <div class="grid-overlay"></div> <div class="scanlines"></div> <div class="glow-effect"></div>

    <!-- Expiration Message (Moved Outside Container) -->
    <div id="expiration-message">
        <i class="material-icons">sentiment_very_dissatisfied</i>
        ${expiredMessage}
    </div>

    <div class="container">
        <!-- Password Input Section -->
        <div id="final-password-section">
            <h1 class="page-title"><i class="material-icons">lock_person</i> Truy C·∫≠p N·ªôi Dung</h1>
            <form class="final-page-password-form" id="password-form" onsubmit="checkFinalPagePassword(event); return false;">
                <div class="final-page-input-group">
                    <label for="final-password-input"><i class="material-icons">password</i> M√£ Truy C·∫≠p:</label>
                    <input type="password" id="final-password-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required>
                </div>
                <!-- --- MODIFIED: Removed admin hint --- -->
                <div class="final-page-donation-prompt">${donateMessage}</div>
                <button type="submit" class="final-page-button" id="final-submit-btn">
                    <i class="material-icons">sensors</i> Gi·∫£i M√£ & Hi·ªÉn Th·ªã
                </button>
                <div class="final-page-error-message" id="final-error-message"></div>
            </form>
        </div>
        <!-- Content Display Section -->
        <div id="final-content-section">
            <div id="embedded-images-container"></div>
             <!-- Div final-markdown-content s·∫Ω c√≥ class 'study-mode' n·∫øu c·∫ßn -->
            <div class="final-template-styles" id="final-markdown-content"></div>
            <div id="embedded-iframes-container"></div>
            <div class="footer-note"><i class="material-icons">verified_user</i> An to√†n v·ªõi 10 l·ªõp m√£ h√≥a AES. v2.2</div>
        </div>
    </div>
    <!-- Modals -->
    <div class="modal-overlay hidden initial-state" id="final-warning-modal">
         <div class="modal-content">
             <h2 class="modal-title"><i class="material-icons">gpp_bad</i> C·∫¢NH B√ÅO</h2>
             <div class="modal-message"> <p>Truy c·∫≠p v√†o v√πng d·ªØ li·ªáu m√£ h√≥a cao.</p> <p>M·ªçi h√†nh vi tr√°i ph√©p ƒë·ªÅu c√≥ th·ªÉ b·ªã ghi nh·∫≠n.</p> <p><strong>Lu√¥n b·∫£o m·∫≠t th√¥ng tin!</strong></p> </div>
             <button class="modal-button" id="final-warning-confirm"> <i class="material-icons">check_circle_outline</i> T√îI ƒê√É HI·ªÇU </button>
        </div>
    </div>
    <div class="modal-overlay hidden initial-state" id="huan-error-modal">
         <div class="modal-content">
            <h2 class="modal-title" style="color: var(--warning);"><i class="material-icons">sentiment_very_dissatisfied</i> Sai R·ªìi Fen!</h2>
            <div class="modal-message" style="font-style: italic;"> <p>${hu·∫•nQuote}</p> </div>
            <button class="modal-button" id="huan-error-confirm"> <i class="material-icons">refresh</i> TH·ª¨ L·∫†I ƒêI </button>
        </div>
    </div>

    <script>
        // === TARGET PAGE SCRIPT (REVISED v2.2 with Study Mode & FreeSOS) ===
        const encryptedMarkdownContent = \`${escapedEncryptedData}\`;
        const pageLayoutMode = \`${escapedPageLayoutMode}\`;
        const imageLayout = \`${escapedImageLayout}\`;
        const embeddedImageUrls = ${imageUrlsJs};
        const embeddedIframeUrls = ${iframeUrlsJs};
        const expiryDetails = ${expiryDetailsJs};
        const adminEncodedPass = ${adminEncodedPassJs}; // Still needed for bypass decryption

        // Elements
        const targetBody = document.getElementById('target-body');
        const expirationMessageDiv = document.getElementById('expiration-message');
        const pageContainer = document.querySelector('.container');
        const finalPasswordSection=document.getElementById('final-password-section');
        const finalContentSection=document.getElementById('final-content-section');
        const finalPasswordInput=document.getElementById('final-password-input');
        const finalErrorMessage=document.getElementById('final-error-message');
        const finalImagesContainer=document.getElementById('embedded-images-container');
        const finalMarkdownContentDiv=document.getElementById('final-markdown-content');
        const finalIframesContainer=document.getElementById('embedded-iframes-container');
        const finalWarningModal=document.getElementById('final-warning-modal');
        const finalWarningConfirmBtn=document.getElementById('final-warning-confirm');
        const huanErrorModal=document.getElementById('huan-error-modal');
        const huanErrorConfirmBtn=document.getElementById('huan-error-confirm');
        const finalParticlesContainer=document.getElementById('final-particles');
        const submitButton=document.getElementById('final-submit-btn');
        let errorTimeout = null;

        // Particles Function
        function createFinalParticles(){ const cont = document.getElementById('final-particles'); if(!cont||cont.children.length>40&&Math.random()<.9)return;cont.innerHTML='';const n=window.innerWidth>768?120:60;for(let i=0;i<n;i++){const p=document.createElement('div');p.classList.add('particle');const s=Math.random()*4+1;const x=Math.random()*window.innerWidth;const d=Math.random()*12;const u=Math.random()*18+12;const o=Math.random()*.4+.1;Object.assign(p.style,{width:\`\${s}px\`,height:\`\${s}px\`,left:\`\${x}px\`,bottom:\`-\${s}px\`,animationDuration:\`\${u}s\`,animationDelay:\`\${d}s\`,opacity:o});const c=['#00f7ff','#6e00ff','#ff00aa'][Math.floor(Math.random()*3)];p.style.background=\`radial-gradient(circle, \${c} 0%, transparent 70%)\`;cont.appendChild(p)}}

        // Decryption Function
        function multiLayerDecrypt(encryptedBase64Data, password, layers = 10) {
            if (typeof CryptoJS === 'undefined') throw new Error("L·ªói: Kh√¥ng t√¨m th·∫•y CryptoJS.");
            let currentData = encryptedBase64Data;
            try {
                for (let i = layers - 1; i >= 0; i--) {
                    const layerKey = password + i; let decryptedBytes;
                    try { decryptedBytes = CryptoJS.AES.decrypt(currentData, layerKey); } catch (e){ throw new Error('decrypt-fail');}
                    let decryptedUtf8;
                    try { decryptedUtf8 = decryptedBytes.toString(CryptoJS.enc.Utf8); } catch (e){ throw new Error('decrypt-fail');}
                    if (!decryptedUtf8 && i > 0) { throw new Error('decrypt-fail'); }
                    if (!decryptedUtf8 && i === 0 && encryptedBase64Data !== "") { /* Allow empty */ }
                    if (decryptedUtf8) {
                        const parts = decryptedUtf8.split("|");
                        if (parts.length < 3 || parts[parts.length - 2] !== password || parseInt(parts[parts.length - 1], 10) !== i) { throw new Error('decrypt-fail'); }
                        currentData = parts.slice(0, parts.length - 2).join('|');
                    } else { currentData = ""; }
                } return currentData;
            } catch (e) { if (e.message !== 'decrypt-fail') { console.error("L·ªói gi·∫£i m√£:", e); } throw new Error('decrypt-fail'); }
        }

        // Error Display Functions
        function showInlineError(message){ clearTimeout(errorTimeout); finalErrorMessage.innerHTML = \`<i class="material-icons">error</i> \${message||'L·ªói kh√¥ng x√°c ƒë·ªãnh'}\`; finalErrorMessage.classList.add('show'); if(finalPasswordInput){finalPasswordInput.classList.add('shake'); setTimeout(()=> finalPasswordInput.classList.remove('shake'), 500);} errorTimeout = setTimeout(() => { finalErrorMessage.classList.remove('show'); }, 3500); }
        function showHuanModal() { if(!huanErrorModal) return; huanErrorModal.classList.add('initial-state'); huanErrorModal.classList.remove('hidden'); requestAnimationFrame(()=>{huanErrorModal.classList.remove('initial-state')}); }
        function isValidUrl(string) { if (!string) return false; try { new URL(string); return string.startsWith('http:') || string.startsWith('https:') || string.startsWith('data:'); } catch (_) { return false; } }

        // Base64 Decode Helper
        function decodeBase64Multi(encodedString, layers = 1) {
            let currentData = encodedString;
            try { for (let i = 0; i < layers; i++) { currentData = atob(currentData); } return currentData; }
            catch (e) { console.warn('Base64 decoding failed:', e); return null; }
        }

        // ---- MODIFIED Check if Admin/FreeSOS View is active ----
        function isAdminOrFreeSosViewActive() {
            const urlParams = new URLSearchParams(window.location.search);
            const viewParam = urlParams.get('view');
            if (!viewParam) { return false; }

            // Check for 'freesos' explicitly
            if (viewParam === 'freesos') {
                console.log("Ch·∫ø ƒë·ªô FreeSOS ƒë∆∞·ª£c k√≠ch ho·∫°t!");
                return true;
            }

            // Check for the original admin key (triple base64 'admin')
            const decodedAdmin = decodeBase64Multi(viewParam, 3);
            if (decodedAdmin === 'admin') {
                console.log("Ch·∫ø ƒë·ªô Admin (legacy) ƒë∆∞·ª£c k√≠ch ho·∫°t!");
                return true;
            }

            return false;
        }
        // ---- END MODIFICATION ----

        // Check Expiration Status
        function isExpired() {
            if (!expiryDetails) { return false; }
            try { const expiryDate = new Date(expiryDetails.year, expiryDetails.month - 1, expiryDetails.day, expiryDetails.hour, expiryDetails.minute, 0); const now = new Date(); return now > expiryDate; }
            catch (e) { console.error("L·ªói parse ng√†y h·∫øt h·∫°n:", e); return false; }
        }

        // --- NEW: Study Mode Processing Function ---
        function processStudyModeContent() {
            if (pageLayoutMode !== 'study' || !finalMarkdownContentDiv) return;
            console.log("Processing Study Mode Content...");
            finalMarkdownContentDiv.classList.add('study-mode');
            const children = Array.from(finalMarkdownContentDiv.children);
            let questionCounter = 0;
            let lastQuestionElement = null;
            let lastAnswerElement = null;

            for (let i = 0; i < children.length; i++) {
                const currentElement = children[i];
                const nextElement = children[i + 1];
                const strongChild = currentElement.querySelector(':scope > strong:only-child');
                const textContentTrimmed = currentElement.textContent.trim();
                const isIndented = /^\s{4,}/.test(currentElement.innerHTML);
                const containsOnlyStrong = strongChild && strongChild.textContent.trim() === textContentTrimmed;
                const isExplanation = currentElement.querySelector(':scope > em > strong') || (currentElement.tagName === 'LI' && currentElement.querySelector(':scope > em > strong'));

                 if (currentElement.tagName === 'P' && containsOnlyStrong && !isIndented) { // Question should not be indented
                     currentElement.classList.add('study-question');
                     lastQuestionElement = currentElement;
                     lastAnswerElement = null;
                     console.log('Found Question:', currentElement.textContent);
                }
                else if (lastQuestionElement && isIndented && containsOnlyStrong) {
                    if (currentElement.previousElementSibling === lastQuestionElement || currentElement.previousElementSibling === lastAnswerElement || currentElement.previousElementSibling?.classList.contains('study-explanation')) {
                         currentElement.classList.add('study-answer');
                         questionCounter++;
                         const answerId = \`study-answer-\${questionCounter}\`;
                         const explanationId = \`study-explanation-\${questionCounter}\`;
                         currentElement.dataset.explanationTarget = explanationId;
                         lastAnswerElement = currentElement;
                         console.log('Found Answer for:', lastQuestionElement.textContent, '->', currentElement.textContent);
                        currentElement.addEventListener('click', function() {
                           const targetId = this.dataset.explanationTarget;
                           const explanationEl = document.getElementById(targetId);
                           if (explanationEl) explanationEl.classList.toggle('visible');
                           else console.warn(\`Explanation target '\${targetId}' not found for\`, this);
                        });
                    }
                }
                else if (lastAnswerElement && (isExplanation || (currentElement.tagName === 'UL' || currentElement.tagName === 'OL') && (currentElement.previousElementSibling === lastAnswerElement || currentElement.previousElementSibling?.classList.contains('study-explanation')) )) { // Explanation follows Answer OR a list following explanation
                     if (currentElement.previousElementSibling === lastAnswerElement || currentElement.previousElementSibling?.classList.contains('study-explanation')) {
                         const explanationId = lastAnswerElement.dataset.explanationTarget;
                         currentElement.classList.add('study-explanation');
                         currentElement.id = explanationId;
                         // Keep lastAnswerElement active for potential list explanation continuation
                         //lastQuestionElement = null; // Don't reset question for list explanation
                         console.log('Found Explanation:', currentElement.textContent);
                    }
                 } else if (!currentElement.classList.contains('study-answer') && !currentElement.classList.contains('study-explanation') && currentElement.tagName !== 'UL' && currentElement.tagName !== 'OL') {
                      // Reset only if it's a new block not related to Q/A/E
                     // lastQuestionElement = null;
                     // lastAnswerElement = null;
                 }
            }
             console.log("Study Mode Processing Finished.");
        }


        // Function to render content (handles Markdown and Study Mode processing)
        function renderContent(decryptedHtml) {
            // Render Images
            finalImagesContainer.innerHTML = ''; finalImagesContainer.className = 'layout-' + imageLayout;
            if (Array.isArray(embeddedImageUrls) && embeddedImageUrls.length > 0) {
                 embeddedImageUrls.forEach(url => {
                    if(isValidUrl(url)) {
                        const item = document.createElement('div'); item.className = 'embedded-image-item';
                        const img = document.createElement('img'); img.alt="·∫¢nh"; img.loading="lazy";
                        img.onerror = () => { item.innerHTML = '<div class="media-error-message"><i class="material-icons">broken_image</i>L·ªói</div>'; img.classList.add('loaded'); };
                        img.onload = () => img.classList.add('loaded'); img.src = url;
                        if (imageLayout !== 'comic') img.onclick = () => window.open(url, '_blank');
                        item.appendChild(img); finalImagesContainer.appendChild(item);
                     } else { console.warn("Link ·∫£nh sai:", url); const eItem=document.createElement('div'); eItem.className='embedded-image-item'; eItem.innerHTML='<div class="media-error-message"><i class="material-icons">link_off</i>Link sai</div>'; finalImagesContainer.appendChild(eItem); }
                });
            }
            // Render Markdown (Standard Conversion)
            finalMarkdownContentDiv.innerHTML = decryptedHtml;

             // Process for Study Mode AFTER rendering standard HTML
            if (pageLayoutMode === 'study') { processStudyModeContent(); }
            else { finalMarkdownContentDiv.classList.remove('study-mode'); }

            // Render Iframes
            finalIframesContainer.innerHTML = '';
            if (Array.isArray(embeddedIframeUrls) && embeddedIframeUrls.length > 0) {
                 embeddedIframeUrls.forEach(url => {
                     if(isValidUrl(url)) {
                        const wrap = document.createElement('div'); wrap.className = 'iframe-item-wrapper';
                        const frame = document.createElement('iframe'); frame.title="Nh√∫ng"; frame.frameborder="0"; frame.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"; frame.allowfullscreen=true; frame.loading="lazy";
                        frame.onerror = () => { wrap.innerHTML = '<div class="media-error-message"><i class="material-icons">video_stable</i>L·ªói iframe</div>'; };
                        wrap.appendChild(frame); finalIframesContainer.appendChild(wrap);
                        setTimeout(() => { frame.src = url; }, 50);
                    } else { console.warn("Link iframe sai:", url); const eWrap = document.createElement('div'); eWrap.className = 'iframe-item-wrapper'; eWrap.style.cssText = 'padding-top:0;min-height:100px;'; eWrap.innerHTML='<div class="media-error-message"><i class="material-icons">link_off</i>Link sai</div>'; finalIframesContainer.appendChild(eWrap); }
                });
            } else { if(finalMarkdownContentDiv) finalMarkdownContentDiv.style.marginBottom='0'; }
        }

        // ---- Function to display content directly (Used by Admin/FreeSOS) ----
        function displayContentAsAdmin() { // Renamed internally for clarity, but function remains
            console.log("Ch·∫ø ƒë·ªô b·ªè qua k√≠ch ho·∫°t. B·ªè qua m·∫≠t kh·∫©u & h·∫øt h·∫°n.");
            // Critical: Use the password embedded during generation for decryption
            if (!adminEncodedPass) { console.error("L·ªói: Kh√¥ng t√¨m th·∫•y m·∫≠t kh·∫©u g·ªëc ƒë√£ m√£ h√≥a."); showInlineError("L·ªói c·∫•u h√¨nh Bypass: Thi·∫øu kh√≥a."); return; }
            let originalPassword;
            try { originalPassword = atob(adminEncodedPass); } catch (e) { console.error("L·ªói gi·∫£i m√£ m·∫≠t kh·∫©u g·ªëc:", e); showInlineError("L·ªói c·∫•u h√¨nh Bypass: Gi·∫£i m√£ kh√≥a th·∫•t b·∫°i."); return; }

            try {
                // Decrypt using the original password obtained from adminEncodedPass
                const decryptedHtml = multiLayerDecrypt(encryptedMarkdownContent, originalPassword, 10);
                renderContent(decryptedHtml); // Render handles Study Mode processing internally now
                finalContentSection.classList.add('visible');
                setTimeout(() => {
                    const focusTarget = finalContentSection.querySelector('.study-question') || finalContentSection.querySelector('h1, h2, h3') || finalImagesContainer || finalIframesContainer || finalContentSection;
                    if (focusTarget && typeof focusTarget.focus === 'function') {
                        focusTarget.setAttribute('tabindex', '-1'); try { focusTarget.focus({ preventScroll: true }); } catch (e) {}
                        window.scrollTo({ top: pageContainer.offsetTop - 20, behavior: 'smooth' });
                    } else { window.scrollTo({ top: pageContainer.offsetTop - 20, behavior: 'smooth' }); }
                }, 200);
            } catch (e) {
                console.error("L·ªói gi·∫£i m√£ ·ªü ch·∫ø ƒë·ªô Bypass:", e);
                showInlineError(e.message === 'decrypt-fail' ? "L·ªói gi·∫£i m√£ Bypass: D·ªØ li·ªáu/Kh√≥a kh√¥ng kh·ªõp." : "L·ªói gi·∫£i m√£ Bypass kh√¥ng x√°c ƒë·ªãnh.");
                finalContentSection.classList.remove('visible'); finalImagesContainer.innerHTML = ''; finalIframesContainer.innerHTML = ''; finalMarkdownContentDiv.innerHTML = '';
            }
        }

        // Password Check (Normal User)
        function checkFinalPagePassword(event){
            if(event)event.preventDefault();const enteredPassword=finalPasswordInput.value.trim();
            finalErrorMessage.classList.remove('show'); finalPasswordInput.classList.remove('shake'); clearTimeout(errorTimeout);

            if(!enteredPassword){showInlineError('Ch∆∞a nh·∫≠p m√£ m√† fen!');finalPasswordInput.focus();return}
            submitButton.disabled=true;submitButton.innerHTML='<i class="material-icons spin">hourglass_top</i> Check pass...';

            setTimeout(()=>{
                try{
                    const decryptedHtml = multiLayerDecrypt(encryptedMarkdownContent, enteredPassword, 10);
                    renderContent(decryptedHtml); // Render handles Study Mode internally
                    finalPasswordSection.classList.add('hiding');
                    finalContentSection.classList.add('visible');
                    setTimeout(()=>{
                        const focusTarget = finalContentSection.querySelector('.study-question') || finalContentSection.querySelector('h1, h2, h3') || finalImagesContainer || finalIframesContainer || finalContentSection;
                        if(focusTarget && typeof focusTarget.focus === 'function') { focusTarget.setAttribute('tabindex', '-1'); try{focusTarget.focus({preventScroll:true});}catch(e){} window.scrollTo({ top: focusTarget.offsetTop - 20, behavior: 'smooth' }); }
                    }, 700);
                } catch(e) {
                     if (e.message === 'decrypt-fail') { showHuanModal(); }
                     else { showInlineError(e.message || "L·ªói x·ª≠ l√Ω kh√¥ng x√°c ƒë·ªãnh."); }
                     finalPasswordInput.value = '';
                     finalContentSection.classList.remove('visible'); finalImagesContainer.innerHTML = ''; finalIframesContainer.innerHTML = ''; finalMarkdownContentDiv.innerHTML = '';
                 } finally {
                     submitButton.disabled = false; submitButton.innerHTML='<i class="material-icons">sensors</i> Gi·∫£i M√£ & Hi·ªÉn Th·ªã';
                 }
            }, 150);
        }

        // ---- MODIFIED Initialization (Checks for FreeSOS/Admin) ----
        document.addEventListener('DOMContentLoaded',()=>{
            createFinalParticles();
            if (finalContentSection) finalContentSection.setAttribute('tabindex','-1'); // Make focusable

            // Use the combined check function
            const isBypassActive = isAdminOrFreeSosViewActive(); // <<< CHANGE HERE
            const hasExpired = isExpired();

            if (isBypassActive) { // <<< CHANGE HERE
                // FreeSOS or Admin Key - Bypass mode
                targetBody.classList.remove('expired');
                if(expirationMessageDiv) expirationMessageDiv.style.display = 'none';
                if(finalPasswordSection) finalPasswordSection.classList.add('hidden'); // Hide password form
                displayContentAsAdmin(); // Decrypt using the embedded original password

            } else if (hasExpired) {
                // Normal user, and content has expired
                targetBody.classList.add('expired');
                if(expirationMessageDiv) expirationMessageDiv.style.display = 'block';
                if(pageContainer) pageContainer.style.display = 'none';
                console.warn("Trang ƒë√£ h·∫øt h·∫°n.");

            } else {
                // Normal user, content not expired, show password prompt
                targetBody.classList.remove('expired');
                if(expirationMessageDiv) expirationMessageDiv.style.display = 'none';
                if(pageContainer) pageContainer.style.display = 'block';
                if(finalPasswordSection) finalPasswordSection.classList.remove('hidden', 'hiding');

                // Show initial warning modal or focus password field
                if(finalWarningModal && finalWarningConfirmBtn){
                    finalWarningModal.classList.remove('hidden','initial-state');
                    const wCH = ()=>{ finalWarningModal.classList.add('hidden'); setTimeout(()=>finalPasswordInput?.focus(), 100); };
                    finalWarningConfirmBtn.onclick=wCH;
                    finalWarningModal.onclick=(e)=>{if(e.target===finalWarningModal) wCH(); };
                } else {
                    setTimeout(() => finalPasswordInput?.focus(), 100);
                }
            }

            // Setup other modals and event listeners
            if(huanErrorModal && huanErrorConfirmBtn){ const hCH=()=>{ huanErrorModal.classList.add('hidden'); setTimeout(()=> finalPasswordInput?.focus(), 100); }; huanErrorConfirmBtn.onclick=hCH; huanErrorModal.onclick=(e)=>{ if(e.target===huanErrorModal) hCH(); }; }
            if (finalPasswordInput) { finalPasswordInput.addEventListener('keydown',(e)=>{ if(e.key === 'Enter') { checkFinalPagePassword(e); } }); }
        });
        // ---- END MODIFIED INITIALIZATION ----

        let finalResizeTimeout; window.addEventListener('resize',()=>{clearTimeout(finalResizeTimeout);finalResizeTimeout=setTimeout(createFinalParticles,300)});

    <\/script>
</body>
</html>`;
        }

        // ====== GENERATOR PAGE FUNCTIONS (REVISED VALIDATION v2.2) ======
        function handleGenerate() {
             const markdownText = markdownInput.value.trim();
             const outputPassword = outputPasswordInput.value;
             const selectedPageLayoutMode = document.querySelector('input[name="page-layout"]:checked')?.value || 'normal';
             const selectedImageLayout = imageLayoutSelect.value;
             const expiryDay = parseInt(expiryDayInput.value, 10); const expiryMonth = parseInt(expiryMonthInput.value, 10); const expiryYear = parseInt(expiryYearInput.value, 10); const expiryHour = parseInt(expiryHourInput.value, 10); const expiryMinute = parseInt(expiryMinuteInput.value, 10);
             let expiryDetails = null; let expiryIsValid = true;
             const expiryFieldsEntered = expiryInputs.some(input => input.value.trim() !== '');

             expiryInputs.forEach(input => input.classList.remove('error', 'shake'));

             if (expiryFieldsEntered) {
                 const allExpiryFieldsFilled = expiryInputs.every(input => input.value.trim() !== '');
                 if (!allExpiryFieldsFilled) {
                      expiryIsValid = false;
                      expiryInputs.forEach(input => { if (input.value.trim() === '') input.classList.add('error'); });
                      showStatus("Nh·∫≠p ƒë·∫ßy ƒë·ªß Ng√†y/Th√°ng/NƒÉm/Gi·ªù/Ph√∫t h·∫øt h·∫°n ho·∫∑c ƒë·ªÉ tr·ªëng t·∫•t c·∫£.", "error", "error_outline", 7000);
                 } else {
                     try {
                         const expiryDateObj = new Date(expiryYear, expiryMonth - 1, expiryDay, expiryHour, expiryMinute, 0); const now = new Date();
                         if (isNaN(expiryDateObj.getTime()) || expiryDateObj.getFullYear() !== expiryYear || expiryDateObj.getMonth() !== expiryMonth - 1 || expiryDateObj.getDate() !== expiryDay || expiryDateObj <= now) {
                             expiryIsValid = false; expiryInputs.forEach(input => input.classList.add('error'));
                             showStatus("Th·ªùi gian h·∫øt h·∫°n kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ ·ªü qu√° kh·ª©.", "error", "error_outline", 7000);
                         } else {
                             expiryDetails = { year: expiryYear, month: expiryMonth, day: expiryDay, hour: expiryHour, minute: expiryMinute };
                         }
                     } catch (e) { expiryIsValid = false; expiryInputs.forEach(input => input.classList.add('error')); showStatus("L·ªói x·ª≠ l√Ω ng√†y gi·ªù h·∫øt h·∫°n.", "error", "error_outline", 7000); console.error("Expiry error:", e); }
                 }
             }

             const getImageUrls = () => { const urls = []; imageUrlList.querySelectorAll('.input-list-item input[type="url"]').forEach(i => { const u=i.value.trim(); i.classList.remove('error', 'shake'); if (u) { if (isValidUrl(u)) { urls.push(u); } else { i.classList.add('error'); } } }); return urls; };
             const getIframeUrls = () => { const urls = []; iframeUrlList.querySelectorAll('.input-list-item input[type="url"]').forEach(i => { const u=i.value.trim(); i.classList.remove('error', 'shake'); if (u) { if (isValidUrl(u)) { urls.push(u); } else { i.classList.add('error'); } } }); return urls; };
             const imageUrls = getImageUrls(); const iframeUrls = getIframeUrls();

             // --- VALIDATION ---
             outputPasswordInput.classList.remove('error', 'shake'); imageLayoutSelect.classList.remove('error'); statusMessage.classList.remove('show');
             let isValid = true; let firstErrorField = null;
             if (!outputPassword || outputPassword.length < 8) { outputPasswordInput.classList.add('error'); if (!firstErrorField) firstErrorField = outputPasswordInput; isValid = false; }
             if (!selectedPageLayoutMode) { console.error("L·ªói kh√¥ng ch·ªçn ƒë∆∞·ª£c layout mode"); isValid = false; }
             if (!selectedImageLayout) { imageLayoutSelect.classList.add('error'); if (!firstErrorField) firstErrorField = imageLayoutSelect; isValid = false; }
             const invalidUrlInputs = document.querySelectorAll('.input-list-item input[type="url"].error');
             if (invalidUrlInputs.length > 0) { if (!firstErrorField) firstErrorField = invalidUrlInputs[0]; isValid = false; }
             if (!expiryIsValid) { if (!firstErrorField) firstErrorField = expiryInputs.find(input => input.classList.contains('error')); isValid = false; }

             if (!isValid) {
                 let errorMsg = "";
                 if (outputPasswordInput.classList.contains('error')) errorMsg += "M·∫≠t kh·∫©u c·∫ßn √≠t nh·∫•t 8 k√Ω t·ª±. ";
                 if (imageLayoutSelect.classList.contains('error')) errorMsg += "Ch∆∞a ch·ªçn ƒë·ªãnh d·∫°ng ·∫£nh. ";
                 if (!expiryIsValid) errorMsg += "Ng√†y gi·ªù h·∫øt h·∫°n kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu. ";
                 if (invalidUrlInputs.length > 0) errorMsg += `C√≥ ${invalidUrlInputs.length} link kh√¥ng h·ª£p l·ªá. `;
                 showStatus(errorMsg.trim() || "Vui l√≤ng ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng nh·∫≠p li·ªáu.", "error", "error_outline", 7000);
                 if (firstErrorField) {
                     firstErrorField.classList.add('shake'); firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' }); try {firstErrorField.focus({ preventScroll: true });} catch(e){} setTimeout(() => firstErrorField.classList.remove('shake'), 500);
                 } else { document.getElementById('generator-container').classList.add('shake'); setTimeout(() => document.getElementById('generator-container').classList.remove('shake'), 500); }
                 return;
             }
             // --- END VALIDATION ---

             // --- GENERATION PROCESS ---
             try {
                 if (typeof marked === 'undefined' || typeof CryptoJS === 'undefined' || typeof btoa === 'undefined' || typeof atob === 'undefined') { throw new Error("Th∆∞ vi·ªán (marked, CryptoJS, Base64) ch∆∞a t·∫£i xong, F5 l·∫°i?"); }
                 let convertedHtml = ""; if (markdownText) { marked.setOptions({ gfm: true, breaks: true, mangle: false, headerIds: false }); convertedHtml = marked.parse(markdownText); }

                 loadAndShowWarningModal(() => {
                     showStatus("ƒêang x·ª≠ l√Ω m√£ h√≥a ƒëa t·∫ßng & c·∫•u h√¨nh...", "info", "hourglass_empty", 0);
                     generateButton.disabled = true; generateButton.innerHTML = '<i class="material-icons spin">sync</i> ƒêANG T·∫†O...';
                     copyButton.disabled = true; copyButton.classList.remove('copied'); copyButton.innerHTML = '<i class="material-icons">content_copy</i> Sao Ch√©p';

                     setTimeout(() => {
                         try {
                             fullHtmlToCopy = generateTargetHtmlTemplate(convertedHtml, outputPassword, selectedPageLayoutMode, selectedImageLayout, imageUrls, iframeUrls, expiryDetails);
                             if (!fullHtmlToCopy || typeof fullHtmlToCopy !== 'string' || fullHtmlToCopy.length < 500) { throw new Error("K·∫øt qu·∫£ t·∫°o HTML l·ªói ho·∫∑c qu√° ng·∫Øn."); }
                             showStatus("Xong! S·∫µn s√†ng copy m√£ ngu·ªìn si√™u ph·∫©m v2.2.", "success", "done_all", 5000);
                             copyButton.disabled = false; copyButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                         } catch (genError) { console.error("L·ªói t·∫°o HTML/m√£ h√≥a:", genError); showStatus(`L·ªói t·∫°o m√£: ${genError.message}`, "error", "error_outline", 10000); fullHtmlToCopy = ''; copyButton.disabled = true;
                         } finally { generateButton.disabled = false; generateButton.innerHTML = '<i class="material-icons">enhanced_encryption</i> T·∫°o M√£ Ngu·ªìn'; }
                     }, 100);
                 }, imageUrls, iframeUrls, expiryDetails, selectedPageLayoutMode);

             } catch (processingError) { console.error("L·ªói x·ª≠ l√Ω:", processingError); showStatus(`L·ªói x·ª≠ l√Ω: ${processingError.message}`, "error", "error", 8000); fullHtmlToCopy = ''; copyButton.disabled = true; generateButton.disabled = false; generateButton.innerHTML = '<i class="material-icons">enhanced_encryption</i> T·∫°o M√£ Ngu·ªìn'; }
        }

        // Copy Function
        function handleCopy() { if (!fullHtmlToCopy) { showStatus("Ch∆∞a c√≥ g√¨ ƒë·ªÉ copy.", "warning", "info", 3000); return; } if (!navigator.clipboard) { showStatus("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ copy t·ª± ƒë·ªông.", "error", "report_problem", 7000); try { console.log("--- BEGIN CODE TO COPY ---"); console.log(fullHtmlToCopy); console.log("--- END CODE TO COPY ---"); alert("L·ªói copy t·ª± ƒë·ªông. M√£ ngu·ªìn ƒë√£ ƒë∆∞·ª£c in ra Console (F12)."); } catch (e) { alert("L·ªói copy v√† c·∫£ l·ªói in ra console!"); } return; } navigator.clipboard.writeText(fullHtmlToCopy).then(() => { showStatus("ƒê√£ copy! ‚ú®", "success", "done_all", 3000); copyButton.classList.add('copied'); copyButton.innerHTML = '<i class="material-icons">check_circle</i> ƒê√£ Copy!'; setTimeout(() => { if (copyButton.classList.contains('copied')) { copyButton.classList.remove('copied'); copyButton.innerHTML = '<i class="material-icons">content_copy</i> Sao Ch√©p'; } }, 3000); }).catch(err => { console.error('L·ªói copy: ', err); showStatus("L·ªói copy!", "error", "report_problem", 5000); }); }

        // Show Confirmation Modal (REVISED v2.2)
        function loadAndShowWarningModal(onConfirmCallback, currentImageUrls = [], currentIframeUrls = [], currentExpiryDetails = null, currentPageLayoutMode = 'normal') {
             const hasImages = currentImageUrls.length > 0; const hasIframes = currentIframeUrls.length > 0; let mediaInfo = '';
             const selectedLayoutText = imageLayoutSelect.options[imageLayoutSelect.selectedIndex].text;
             const pageLayoutText = currentPageLayoutMode === 'study' ? "Study Mode ‚ú®" : "B√¨nh th∆∞·ªùng";
             if (hasImages || hasIframes) { mediaInfo += `<p style="color:var(--primary); display: flex; align-items: center; gap: 0.5em; justify-content: center; margin-bottom: 0.5rem;"><i class="material-icons">perm_media</i><strong>N·ªôi dung nh√∫ng th√™m:</strong></p>`; const listStyle = 'style="list-style: none; padding: 0; margin: 0 auto; max-width: 80%; text-align: left;"'; mediaInfo += `<ul ${listStyle}>`; if (hasImages) mediaInfo += `<li style="margin-bottom: 0.3rem;"><i class="material-icons" style="vertical-align: middle; margin-right: 0.3em; font-size: 1.2em; color: var(--success);">image</i>${currentImageUrls.length} ·∫¢nh (Layout: ${selectedLayoutText})</li>`; if (hasIframes) mediaInfo += `<li><i class="material-icons" style="vertical-align: middle; margin-right: 0.3em; font-size: 1.2em; color: var(--accent);">integration_instructions</i>${currentIframeUrls.length} Iframe/Video</li>`; mediaInfo += `</ul>`; } else { mediaInfo = '<p style="color:var(--text-dim); font-style: italic; display: flex; align-items: center; gap: 0.5em; justify-content: center;"><i class="material-icons">web_asset_off</i>Kh√¥ng nh√∫ng th√™m ·∫£nh/iframe.</p>'; }
             let expiryInfo = '';
             if (currentExpiryDetails) { const { day, month, year, hour, minute } = currentExpiryDetails; const pD = String(day).padStart(2, '0'); const pM = String(month).padStart(2, '0'); const pH = String(hour).padStart(2, '0'); const pMin = String(minute).padStart(2, '0'); expiryInfo = `<p style="color:var(--accent); display: flex; align-items: center; gap: 0.5em; justify-content: center; margin-top: 1rem;"><i class="material-icons">timer_off</i><strong>H·∫øt h·∫°n v√†o:</strong> ${pD}/${pM}/${year} l√∫c ${pH}:${pMin}</p>`;
             } else { expiryInfo = `<p style="color:var(--text-dim); font-style: italic; display: flex; align-items: center; gap: 0.5em; justify-content: center; margin-top: 1rem;"><i class="material-icons">timer</i>Kh√¥ng ƒë·∫∑t th·ªùi gian h·∫øt h·∫°n.</p>`; }
             const modalHtml = `
                 <div class="modal-content">
                    <h2 class="modal-title"><i class="material-icons">security</i> X√°c nh·∫≠n t·∫°o m√£ v2.2</h2>
                    <div class="modal-message" style="text-align: center;">
                        <p>N·ªôi dung (n·∫øu c√≥) v√† media s·∫Ω ƒë∆∞·ª£c b·∫£o v·ªá b·∫±ng <strong>10 l·ªõp AES</strong>.<br>H√£y ch·∫Øc ch·∫Øn b·∫°n nh·ªõ m·∫≠t kh·∫©u nh√©!</p>
                         <p style="margin-top: 1rem; color:var(--primary); font-weight:bold; display: flex; align-items: center; gap: 0.5em; justify-content: center;">
                             <i class="material-icons">view_quilt</i>B·ªë c·ª•c trang: ${pageLayoutText}
                         </p>
                        <hr style="border:0; height:1px; background:var(--md-border); margin: 1.2rem auto; width: 60%;">
                        ${mediaInfo} ${expiryInfo}
                        <hr style="border:0; height:1px; background:var(--md-border); margin: 1.2rem auto; width: 60%;">
                        <p style="color:var(--warning);font-weight:bold; display: flex; align-items: center; gap: 0.5em; justify-content: center;"><i class="material-icons">warning_amber</i> Nh·∫•n OK ƒë·ªÉ x√°c nh·∫≠n t·∫°o m√£ ngu·ªìn.</p>
                    </div>
                     <button class="modal-button" id="gen-warning-confirm"><i class="material-icons">check_circle</i> OK, T·∫°o Ngay!</button>
                 </div>`;
             warningModal.innerHTML = modalHtml; const confirmBtn = warningModal.querySelector('#gen-warning-confirm');
             const confirmHandler = () => { warningModal.classList.add('hidden'); if (typeof onConfirmCallback === 'function') setTimeout(onConfirmCallback, 50); warningModal.removeEventListener('click', outsideClickHandler); };
             const outsideClickHandler = (event) => { if (event.target === warningModal) { warningModal.classList.add('hidden'); warningModal.removeEventListener('click', outsideClickHandler); } };
             confirmBtn.onclick = confirmHandler; warningModal.addEventListener('click', outsideClickHandler);
             warningModal.classList.add('initial-state'); warningModal.classList.remove('hidden'); requestAnimationFrame(() => { warningModal.classList.remove('initial-state'); });
         }

        // ====== INITIALIZATION (Generator Page v2.2) ======
        document.addEventListener('DOMContentLoaded', function() {
            try {
                 createParticles(particlesContainer);
                 generateButton.addEventListener('click', handleGenerate);
                 copyButton.addEventListener('click', handleCopy);
                 [outputPasswordInput, ...expiryInputs].forEach(input => {
                    if(input) { input.addEventListener('input', () => { input.classList.remove('error', 'shake'); }); input.addEventListener('change', () => { input.classList.remove('error', 'shake'); }); }
                 });
                 imageLayoutSelect.addEventListener('change', () => imageLayoutSelect.classList.remove('error'));
                 showStatus("‚ú® S·∫µn s√†ng m√£ h√≥a & nh√∫ng ƒëa ph∆∞∆°ng ti·ªán v2.2! ‚ú®", "info", "auto_awesome", 7000);
                 let resizeTimeout; window.addEventListener('resize', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(() => createParticles(particlesContainer), 300); });
            } catch (e) { console.error("L·ªói kh·ªüi t·∫°o:", e); alert("L·ªói kh·ªüi t·∫°o trang Generator. Ki·ªÉm tra Console (F12)."); showStatus("L·ªói kh·ªüi t·∫°o nghi√™m tr·ªçng!", "error", "report_problem", 0); }
        });
    </script>
</body>
</html>
